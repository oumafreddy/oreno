{% extends 'base.html' %}
{% load static %}
{% block title %}Compliance Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h2 class="mb-0">Compliance Dashboard</h2>
        </div>
        <div class="col-auto ms-auto">
            <a href="{% url 'compliance:reports' %}" class="btn btn-outline-warning me-2">Reports</a>
            <a href="{% url 'compliance:framework_list' %}" class="btn btn-primary me-2">Framework List</a>
            <a href="{% url 'compliance:requirement_list' %}" class="btn btn-outline-success me-2">Requirement List</a>
            <a href="{% url 'compliance:obligation_list' %}" class="btn btn-outline-warning me-2">Obligation List</a>
            <a href="{% url 'compliance:evidence_list' %}" class="btn btn-outline-info">Evidence List</a>
            <a href="{% url 'compliance:policydocument_list' %}" class="btn btn-outline-secondary">Policy Document List</a>
        </div>
    </div>
    <!-- Advanced Analytics Cards (top) -->
    <div class="row mb-4 g-3">
        <div class="col-md-2">
            <div class="card text-bg-info h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-bar-chart"></i></div>
                    <h6 class="card-title">Frameworks (Distinct)</h6>
                    <h3>{{ requirement_framework_dist|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-success h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-pie-chart"></i></div>
                    <h6 class="card-title">Jurisdictions (Distinct)</h6>
                    <h3>{{ requirement_jurisdiction_chart|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-warning h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-check2-circle"></i></div>
                    <h6 class="card-title">Mandatory</h6>
                    <h3>{{ requirement_mandatory_dist.Mandatory }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-secondary h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-x-circle"></i></div>
                    <h6 class="card-title">Optional</h6>
                    <h3>{{ requirement_mandatory_dist.Optional }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-danger h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-exclamation-triangle"></i></div>
                    <h6 class="card-title">Overdue Obligations</h6>
                    <h3>{{ obligation_overdue_ontime.Overdue }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-primary h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-calendar-check"></i></div>
                    <h6 class="card-title">Completed Obligations</h6>
                    <h3>{{ obligation_completion_rate.Completed }}</h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Advanced Analytics Charts (below summary cards) -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Requirements by Framework</strong></div>
                <div class="card-body">
                    <div id="framework-dist-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Obligation Status (Overdue/On Time)</strong></div>
                <div class="card-body">
                    <div id="obligation-overdue-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Policy Expiry Distribution</strong></div>
                <div class="card-body">
                    <div id="policy-expiry-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Owner Workload Chart -->
    <div class="row mb-4 g-3">
        <div class="col-md-12">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Obligation Owner Workload</strong></div>
                <div class="card-body">
                    <div id="owner-workload-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Summary Cards Row -->
    <div class="row g-4 mb-4 justify-content-center">
        <div class="col-md-2">
            <div class="card text-bg-primary h-100 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-diagram-3 display-4 mb-2"></i>
                    <h5 class="card-title">Frameworks</h5>
                    <h3><a href="{% url 'compliance:framework_list' %}" class="stretched-link text-white text-decoration-none">{{ framework_count }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-success h-100 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-list-check display-4 mb-2"></i>
                    <h5 class="card-title">Requirements</h5>
                    <h3><a href="{% url 'compliance:requirement_list' %}" class="stretched-link text-white text-decoration-none">{{ requirement_count }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-warning h-100 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-flag display-4 mb-2"></i>
                    <h5 class="card-title">Obligations</h5>
                    <h3><a href="{% url 'compliance:obligation_list' %}" class="stretched-link text-white text-decoration-none">{{ obligation_count }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-info h-100 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-check display-4 mb-2"></i>
                    <h5 class="card-title">Evidences</h5>
                    <h3><a href="{% url 'compliance:evidence_list' %}" class="stretched-link text-white text-decoration-none">{{ evidence_count }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-secondary h-100 shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-text display-4 mb-2"></i>
                    <h5 class="card-title">Policy Docs</h5>
                    <h3><a href="{% url 'compliance:policydocument_list' %}" class="stretched-link text-white text-decoration-none">{{ policydocument_count }}</a></h3>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white"><strong>Recent Compliance Activity</strong></div>
                <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                    {% for activity in recent_activity %}
                        <li class="list-group-item">
                            <i class="bi bi-info-circle me-2 text-primary"></i>
                            <span>{{ activity.message }}</span>
                            <span class="text-muted float-end">{{ activity.timestamp|date:"M d, Y H:i" }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No recent activity.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Quick Actions</strong></div>
                <div class="card-body">
                    <a href="{% url 'compliance:framework_create' %}" class="btn btn-primary mb-2 w-100">Add Framework</a>
                    <a href="{% url 'compliance:requirement_create' %}" class="btn btn-outline-success mb-2 w-100">Add Requirement</a>
                    <a href="{% url 'compliance:obligation_create' %}" class="btn btn-outline-warning mb-2 w-100">Add Obligation</a>
                    <a href="{% url 'compliance:evidence_create' %}" class="btn btn-outline-info mb-2 w-100">Add Evidence</a>
                    <a href="{% url 'compliance:policydocument_create' %}" class="btn btn-outline-secondary mb-2 w-100">Add Policy Document</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Reports Section (Bottom) -->
    <div class="row mt-5">
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <strong><i class="bi bi-file-earmark-bar-graph"></i> Compliance Reports</strong>
                </div>
                <div class="card-body text-center">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Access Professional Compliance Reports</strong><br>
                        Generate and download comprehensive compliance management reports with advanced filtering options.
                    </div>
                    <a href="{% url 'compliance:reports' %}" class="btn btn-warning btn-lg">
                        <i class="bi bi-file-earmark-text me-2"></i>View All Reports
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- END Compliance Reports Section -->
</div>
<!-- JSON data for Plotly charts -->
{{ requirement_framework_dist|json_script:"requirement-framework-data" }}
{{ obligation_overdue_ontime|json_script:"obligation-overdue-ontime-data" }}
{{ policy_expiry_dist|json_script:"policy-expiry-data" }}
{{ obligation_owner_workload|json_script:"obligation-owner-workload-data" }}
<!-- Modal for Requirement List -->
<div class="modal fade" id="requirementListModal" tabindex="-1" aria-labelledby="requirementListModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="requirementListModalLabel">Requirements Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group">
          {% for req in requirements %}
            <li class="list-group-item">{{ req.title }} - {{ req.status }}</li>
          {% empty %}
            <li class="list-group-item text-muted">No requirements found.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
<div id="compliance-dashboard-vars"
     data-framework-url="{% url 'compliance:api_framework_data' %}"
     data-obligation-url="{% url 'compliance:api_obligation_data' %}"
     data-policy-expiry-url="{% url 'compliance:api_policy_expiry_data' %}">
</div>
{% endblock %}
{% block extra_scripts %}
<script src="{% static 'js/compliance_dashboard.js' %}" defer nonce="{{ request.csp_nonce }}"></script>
{% endblock %} 