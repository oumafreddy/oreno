{% extends "reports/base_report.html" %}
{% load crispy_forms_tags %}

{% block content %}
<!-- Filter Form (shown only in HTML, not in PDF) -->
{% if not for_pdf %}
  <div class="report-card no-print">
    <h3>Report Filters</h3>
    <form method="get" class="mb-0">
      {% if filter_form %}
        {% crispy filter_form %}
      {% endif %}
      <button type="submit" class="btn btn-primary">Apply Filter</button>
      <a href="?download=pdf{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.code %}&code={{ request.GET.code }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.owner %}&owner={{ request.GET.owner }}{% endif %}{% if request.GET.register %}&register={{ request.GET.register }}{% endif %}" class="btn btn-success">Download PDF</a>
    </form>
  </div>
{% endif %}

<!-- Report Header -->
<div class="report-header">
  <div class="header-content">
    <div class="header-left">
      Report ID: Risk Register Analysis
    </div>
    <div class="header-right">
      {% if organization.logo and organization.logo.url %}
        <img src="{{ organization.logo.url }}" alt="{{ organization.name }} Logo" class="organization-logo" />
      {% else %}
        <span>{{ organization.name }}</span>
      {% endif %}
    </div>
  </div>
</div>
<div class="header-separator"></div>

<h2 class="section-header">A. Risk Register Analysis</h2>

<!-- Summary Statistics -->
<div class="report-card">
  <h3>Risk Summary</h3>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-number">{{ risks.count }}</div>
      <div class="stat-label">Total Risks</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ risks|dictsort:"status"|length }}</div>
      <div class="stat-label">Active Risks</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">{{ risks|dictsort:"risk_score"|length }}</div>
      <div class="stat-label">High Priority</div>
    </div>
  </div>
</div>

<!-- Individual Risk Details -->
{% for risk in risks %}
<div class="report-card">
  <h3>Risk {{ forloop.counter }}: {{ risk.title }}</h3>
  <div class="priority-indicator">Risk Level: {{ risk.get_risk_impact_display }}</div>
  
  <table class="report-table">
    <tr>
      <th>Risk Code</th>
      <td>{{ risk.code|default:"Not specified" }}</td>
      <th>Category</th>
      <td>{{ risk.get_risk_category_display }}</td>
    </tr>
    <tr>
      <th>Impact</th>
      <td><span class="risk-level risk-{{ risk.risk_impact|lower }}">{{ risk.get_risk_impact_display }}</span></td>
      <th>Likelihood</th>
      <td><span class="risk-level risk-{{ risk.risk_likelihood|lower }}">{{ risk.get_risk_likelihood_display }}</span></td>
    </tr>
    <tr>
      <th>Risk Score</th>
      <td>{{ risk.risk_score|default:"Not calculated" }}</td>
      <th>Residual Risk</th>
      <td>{{ risk.residual_risk_score|default:"Not calculated" }}</td>
    </tr>
    <tr>
      <th>Owner</th>
      <td>{% if risk.risk_owner %}{{ risk.risk_owner|default:"Not specified" }}{% else %}Not specified{% endif %}</td>
      <th>Status</th>
      <td><span class="status-badge status-{{ risk.status|lower }}">{{ risk.get_status_display }}</span></td>
    </tr>
  </table>

  <div class="field-label">Risk Description</div>
  <div class="field-value">
    {{ risk.description|safe }}
  </div>

  {% if risk.existing_controls %}
  <div class="field-label">Existing Controls</div>
  <div class="field-value">
    {{ risk.existing_controls|safe }}
  </div>
  {% endif %}

  {% if risk.mitigation_strategy %}
  <div class="field-label">Mitigation Strategy</div>
  <div class="field-value">
    {{ risk.mitigation_strategy|safe }}
  </div>
  {% endif %}

  {% if risk.action_plan %}
  <div class="field-label">Action Plan</div>
  <div class="field-value">
    {{ risk.action_plan|safe }}
  </div>
  {% endif %}

  {% if risk.additional_notes %}
  <div class="field-label">Additional Notes</div>
  <div class="field-value">
    {{ risk.additional_notes|safe }}
  </div>
  {% endif %}
</div>
{% empty %}
<div class="alert alert-info">
  <strong>No Risks Found:</strong> No risks match the current filter criteria.
</div>
{% endfor %}
{% endblock %} 