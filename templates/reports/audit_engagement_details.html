{% extends "reports/base_report.html" %}
{% load crispy_forms_tags %}

{% block content %}
{% if engagement %}
  <!-- Cover Page -->
  <div class="cover-page">
    <div class="logo-section">
      {% if organization.logo and organization.logo.url %}
        <img src="{{ organization.logo.url }}" alt="{{ organization.name }} Logo" class="organization-logo" />
      {% else %}
        <div class="default-logo-placeholder">
          <h2>{{ organization.name }}</h2>
        </div>
      {% endif %}
    </div>
    
    <div class="report-title-section">
      <h1 class="report-title">{{ engagement.title }}</h1>
      <p class="report-subtitle">Audit Engagement Report</p>
    </div>
  </div>

  <div class="page-break"></div>

  <h2 class="section-header">A. Engagement Details</h2>
  <div class="report-card">
    <h3>Basic Information</h3>
    <table class="report-table" style="font-size: 10pt;">
      <tr>
        <th style="width:20%">Engagement Title</th>
        <td colspan="3">{{ engagement.title }}</td>
      </tr>
      <tr>
        <th>Status</th>
        <td><span class="status-badge status-{{ engagement.project_status|lower }}">{{ engagement.get_project_status_display }}</span></td>
        <th style="width:15%">Workplan</th>
        <td>{% if engagement.annual_workplan %}{{ engagement.annual_workplan.name }}{% if engagement.annual_workplan.fiscal_year %} ({{ engagement.annual_workplan.fiscal_year }}){% endif %}{% else %}Not specified{% endif %}</td>
      </tr>
      <tr>
        <th>Start Date</th>
        <td>{{ engagement.project_start_date|date:"F j, Y" }}</td>
        <th>Report Issued Date</th>
        <td>{{ engagement.report_issued_date|date:"F j, Y"|default:"Not specified" }}</td>
      </tr>
      <tr>
        <th>Estimated Hours</th>
        <td colspan="3">{{ engagement.estimated_hours|default:"Not specified" }}</td>
      </tr>
    </table>
    
    {% if engagement.executive_summary %}
    <div style="margin-top: 0.5cm;">
      <div class="field-label">Executive Summary</div>
      <div class="field-value">{{ engagement.executive_summary|safe }}</div>
    </div>
    {% endif %}
  </div>

  <h2 class="section-subheader">1. Purpose and Background</h2>
  <div class="report-card">
    {% if engagement.purpose %}
    <div class="field-group">
      <div class="field-label">Purpose</div>
      <div class="field-value">{{ engagement.purpose|safe }}</div>
    </div>
    {% endif %}
    {% if engagement.background %}
    <div class="field-group">
      <div class="field-label">Background</div>
      <div class="field-value">{{ engagement.background|safe }}</div>
    </div>
    {% endif %}
  </div>

  <h2 class="section-subheader">2. Audit Objectives</h2>
  {% if engagement.objectives.all %}
  <div class="report-card">
    <h3>Audit Objectives</h3>
    <table class="report-table" style="font-size: 10pt;">
      <thead><tr><th style="width:8%">#</th><th>Objective Title</th></tr></thead>
      <tbody>
      {% for objective in engagement.objectives.all %}
        <tr><td>{{ forloop.counter }}</td><td><strong>{{ objective.title }}</strong></td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <h2 class="section-subheader">3. Conclusion</h2>
  <div class="report-card">
    <h3>Audit Conclusion</h3>
    <table class="report-table" style="font-size: 10pt;">
      <tr><th style="width:20%">Conclusion</th><td><span class="status-badge status-{{ engagement.conclusion|lower }}">{{ engagement.get_conclusion_display }}</span></td></tr>
      {% if engagement.conclusion_description %}<tr><th>Conclusion Description</th><td>{{ engagement.conclusion_description|safe }}</td></tr>{% endif %}
    </table>
  </div>

  {% if engagement.all_issues %}
  <h2 class="section-subheader">4. Issues and Findings</h2>

  {% for issue in engagement.all_issues %}
  <div class="report-card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <h3 style="margin:0;">Issue {{ forloop.counter }}: {{ issue.issue_title }}</h3>
      <span class="priority-indicator">Severity: {{ issue.get_risk_level_display|default:issue.risk_level }}</span>
    </div>

    {% if issue.issue_description %}
    <div class="field-label">Issue Description</div>
    <div class="field-value">{{ issue.issue_description|safe }}</div>
    {% endif %}

    {% if issue.root_cause %}
    <div class="field-label">Root Cause</div>
    <div class="field-value">{{ issue.root_cause|safe }}</div>
    {% endif %}

    {% with recs=issue.recommendations.all %}
      {% if recs %}
      <div class="field-label">Recommendations</div>
      <div class="field-value">
        <ol style="margin:0; padding-left:1.2em;">
          {% for rec in recs %}
            <li>
              <div><strong>{{ rec.title }}</strong></div>
              {% if rec.description %}<div>{{ rec.description|safe }}</div>{% endif %}
            </li>
          {% endfor %}
        </ol>
      </div>
      {% endif %}
    {% endwith %}

    {% if issue.risks %}
    <div class="field-label">Risks</div>
    <div class="field-value">{{ issue.risks|safe }}</div>
    {% endif %}

    {% if issue.management_action_plan %}
    <div class="field-label">Management Action Plan</div>
    <div class="field-value">{{ issue.management_action_plan|safe }}</div>
    {% endif %}
  </div>
  {% endfor %}
  {% endif %}

{% else %}
  <div class="alert alert-warning"><strong>No Engagement Found:</strong> {% if filters.engagement_name %}No engagement found matching "{{ filters.engagement_name }}"{% else %}Please select an engagement to view details{% endif %}</div>
{% endif %}
{% endblock %} 