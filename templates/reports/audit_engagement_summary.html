{% extends "reports/base_report.html" %}
{% load crispy_forms_tags %}

{% block content %}
<!-- Filter Form (shown only in HTML, not in PDF) -->
{% if not for_pdf %}
  <div class="report-card no-print">
    <h3>Report Filters</h3>
    <form method="get" class="mb-2">
      <label for="engagement_name">Engagement Name:</label>
      <select name="engagement_name" id="engagement_name" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
        <option value="">All</option>
        {% for name in engagement_names %}
          <option value="{{ name }}" {% if filters.engagement_name == name %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
      
      <label for="status" class="ms-3">Status:</label>
      <select name="status" id="status" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
        <option value="">All</option>
        <option value="planning" {% if filters.status == 'planning' %}selected{% endif %}>Planning</option>
        <option value="fieldwork" {% if filters.status == 'fieldwork' %}selected{% endif %}>Fieldwork</option>
        <option value="reporting" {% if filters.status == 'reporting' %}selected{% endif %}>Reporting</option>
        <option value="review" {% if filters.status == 'review' %}selected{% endif %}>Review</option>
        <option value="completed" {% if filters.status == 'completed' %}selected{% endif %}>Completed</option>
        <option value="cancelled" {% if filters.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
      </select>
      
      <label for="assigned_to" class="ms-3">Assigned To:</label>
      <input type="text" name="assigned_to" id="assigned_to" class="form-control form-control-sm d-inline w-auto" 
             value="{{ filters.assigned_to|default:'' }}" placeholder="Email" onchange="this.form.submit()">
      
      <a href="?download=pdf{% if filters.engagement_name %}&engagement_name={{ filters.engagement_name }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.assigned_to %}&assigned_to={{ filters.assigned_to }}{% endif %}" class="btn btn-success ms-3">Download PDF</a>
    </form>
  </div>
{% endif %}

<!-- Report Header -->
<div class="report-header">
  <div class="header-content">
    <div class="header-left">&nbsp;</div>
    <div class="header-right">
      {% if organization.logo and organization.logo.url %}
        <img src="{{ organization.logo.url }}" alt="{{ organization.name }} Logo" class="organization-logo" />
      {% else %}<span>{{ organization.name }}</span>{% endif %}
    </div>
  </div>
</div>
<div class="header-separator"></div>

<h2 class="section-header">A. Audit Engagement Summary</h2>

<!-- Summary Statistics & Filters -->
<div class="report-card">
  <h3>Engagement Overview & Filters</h3>
  <table class="report-table" style="table-layout: fixed; margin-top: 0; margin-bottom: 0.5cm;">
    <colgroup>
      <col style="width:33.33%">
      <col style="width:33.33%">
      <col style="width:33.33%">
    </colgroup>
    <tr>
      <td class="text-center"><div class="stat-number" style="margin:0;">{{ total_engagements }}</div><div class="stat-label" style="margin:0;">Total Engagements</div></td>
      <td class="text-center"><div class="stat-number" style="margin:0;">{{ active_engagements }}</div><div class="stat-label" style="margin:0;">Active Engagements</div></td>
      <td class="text-center"><div class="stat-number" style="margin:0;">{{ assigned_auditors }}</div><div class="stat-label" style="margin:0;">Assigned Auditors</div></td>
    </tr>
  </table>
  
  <table class="report-table" style="margin-top: 0.5cm;">
    <tr>
      <th style="width:25%">Status</th>
      <td>{{ filters.status|default:"All Statuses" }}</td>
      <th style="width:25%">Assigned To</th>
      <td>{{ filters.assigned_to|default:"All Auditors" }}</td>
    </tr>
    <tr>
      <th>Engagement Name</th>
      <td>{{ filters.engagement_name|default:"All Engagements" }}</td>
      <th>Organization</th>
      <td>{{ organization.name }}</td>
    </tr>
  </table>
</div>

<!-- Engagement Summary Table -->
<div class="report-card">
  <h3>Engagement Summary by Status and Assignment</h3>
  <table class="report-table">
    <thead>
      <tr>
        <th>Status</th>
        <th>Assigned To</th>
        <th>Count</th>
        <th>Percentage</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      {% for row in summary %}
      <tr>
        <td><span class="status-badge status-{{ row.project_status|lower }}">{{ row.project_status|title }}</span></td>
        <td>{% if row.assigned_to__email %}{{ row.assigned_to__email }}{% else %}Unassigned{% endif %}</td>
        <td><strong>{{ row.count }}</strong></td>
        <td>{{ row.count|floatformat:1 }}%</td>
        <td>
          {% if row.project_status == 'planning' %}
            Engagements in initial planning phase
          {% elif row.project_status == 'fieldwork' %}
            Engagements currently in fieldwork
          {% elif row.project_status == 'reporting' %}
            Engagements in reporting phase
          {% elif row.project_status == 'review' %}
            Engagements under review
          {% elif row.project_status == 'completed' %}
            Successfully completed engagements
          {% elif row.project_status == 'cancelled' %}
            Cancelled engagements
          {% else %}
            {{ row.project_status|title }} status engagements
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Detailed Analysis -->
<div class="report-card">
  <h3>Detailed Analysis</h3>
  
  <!-- By Status -->
  <h4 class="section-subsubheader">By Status</h4>
  <table class="report-table">
    <thead>
      <tr>
        <th>Status</th>
        <th>Count</th>
        <th>Percentage</th>
        <th>Average Duration</th>
        <th>Completion Rate</th>
      </tr>
    </thead>
    <tbody>
      {% regroup summary by project_status as status_list %}
      {% for status in status_list %}
      <tr>
        <td><span class="status-badge status-{{ status.grouper|lower }}">{{ status.grouper|title }}</span></td>
        <td><strong>{{ status.list|length }}</strong></td>
        <td>{{ status.list|length|floatformat:1 }}%</td>
        <td>
          {% if status.grouper == 'completed' %}
            Completed
          {% elif status.grouper == 'cancelled' %}
            N/A
          {% else %}
            In Progress
          {% endif %}
        </td>
        <td>
          {% if status.grouper == 'completed' %}
            100%
          {% elif status.grouper == 'cancelled' %}
            0%
          {% else %}
            Pending
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- By Assignment -->
  <h4 class="section-subsubheader">By Assignment</h4>
  <table class="report-table">
    <thead>
      <tr>
        <th>Assigned To</th>
        <th>Total Engagements</th>
        <th>Active</th>
        <th>Completed</th>
        <th>Workload Distribution</th>
      </tr>
    </thead>
    <tbody>
      {% regroup summary by assigned_to__email as assignment_list %}
      {% for assignment in assignment_list %}
      <tr>
        <td><strong>{% if assignment.grouper %}{{ assignment.grouper }}{% else %}Unassigned{% endif %}</strong></td>
        <td><strong>{{ assignment.list|length }}</strong></td>
        <td>
          {% for item in assignment.list %}
            {% if item.project_status != 'completed' and item.project_status != 'cancelled' %}
              {{ item.count }}
            {% endif %}
          {% endfor %}
        </td>
        <td>
          {% for item in assignment.list %}
            {% if item.project_status == 'completed' %}
              {{ item.count }}
            {% endif %}
          {% endfor %}
        </td>
        <td>
          {% if assignment.list|length > 3 %}
            <span class="status-badge status-pending">High Workload</span>
          {% elif assignment.list|length > 1 %}
            <span class="status-badge status-active">Moderate</span>
          {% else %}
            <span class="status-badge status-draft">Light</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Performance Metrics -->
<div class="report-card">
  <h3>Performance Metrics</h3>
  
  <div class="field-label">Engagement Status Distribution</div>
  <div class="field-value">
    <p>The engagement summary shows the current distribution of audit engagements across different phases of the audit lifecycle. 
    This helps identify bottlenecks and resource allocation needs.</p>
    
    <p><strong>Key Metrics:</strong></p>
    <ul>
      <li><strong>Total Engagements:</strong> {{ total_engagements|default:summary|length }} engagements across all statuses</li>
      <li><strong>Active Engagements:</strong> {{ active_engagements|default:summary|dictsort:"project_status"|length }} engagements currently in progress (planning, fieldwork, reporting, review)</li>
      <li><strong>Completion Rate:</strong> Percentage of engagements that have reached completion status</li>
      <li><strong>Resource Distribution:</strong> {{ assigned_auditors|default:summary|dictsort:"assigned_to__email"|length }} auditors with assigned engagements</li>
    </ul>
  </div>

  <div class="field-label">Resource Management Insights</div>
  <div class="field-value">
    <ul>
      <li><strong>Workload Balance:</strong> Monitor the distribution of engagements across auditors to ensure balanced workload</li>
      <li><strong>Bottleneck Identification:</strong> Identify stages where engagements tend to get stuck (e.g., review phase)</li>
      <li><strong>Capacity Planning:</strong> Use engagement counts to plan resource allocation for upcoming periods</li>
      <li><strong>Performance Tracking:</strong> Track completion rates to measure audit team efficiency</li>
    </ul>
  </div>
</div>

<!-- Recommendations -->
<div class="report-card">
  <h3>Key Insights & Recommendations</h3>
  
  {% if summary %}
  <div class="field-label">Strategic Recommendations</div>
  <div class="field-value">
    <ul>
      <li><strong>Resource Optimization:</strong> Analyze workload distribution to ensure balanced assignment of engagements across audit team members.</li>
      <li><strong>Process Improvement:</strong> Identify stages with high engagement counts to optimize workflow and reduce bottlenecks.</li>
      <li><strong>Capacity Planning:</strong> Use engagement status data to forecast resource needs for upcoming audit cycles.</li>
      <li><strong>Performance Monitoring:</strong> Track engagement progression to identify areas for process improvement and training needs.</li>
      <li><strong>Quality Assurance:</strong> Monitor completion rates and review processes to maintain audit quality standards.</li>
    </ul>
  </div>
  {% endif %}
</div>

{% if not summary %}
<div class="alert alert-info">
  <strong>No Engagements Found:</strong> No engagements match the current filter criteria. Please adjust your filters or create new engagements.
</div>
{% endif %}
{% endblock %} 