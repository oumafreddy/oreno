{% extends 'reports/base_report.html' %}

{% block content %}
<div class="report-header">
  <div class="header-content">
    <div class="header-left">
      <strong>{{ organization.name }}</strong><br>
      Test Run Details Report
    </div>
    <div class="header-right">
      Generated: {{ generation_timestamp }}<br>
      Test Run ID: {{ test_run.id }}
    </div>
  </div>
</div>

<div class="section-header">Test Run Summary</div>
<div class="summary-box">
  <div class="summary-grid">
    <div class="summary-item">
      <strong>Model:</strong> {{ test_run.model_asset.name }}
    </div>
    <div class="summary-item">
      <strong>Dataset:</strong> {{ test_run.dataset_asset.name|default:"N/A" }}
    </div>
    <div class="summary-item">
      <strong>Test Plan:</strong> {{ test_run.test_plan.name|default:"N/A" }}
    </div>
    <div class="summary-item">
      <strong>Status:</strong> <span class="status-{{ test_run.status }}">{{ test_run.status|title }}</span>
    </div>
    <div class="summary-item">
      <strong>Created:</strong> {{ test_run.created_at|date:"Y-m-d H:i:s" }}
    </div>
    {% if test_run.completed_at %}
    <div class="summary-item">
      <strong>Completed:</strong> {{ test_run.completed_at|date:"Y-m-d H:i:s" }}
    </div>
    {% endif %}
    {% if test_run.started_at and test_run.completed_at %}
    <div class="summary-item">
      <strong>Duration:</strong> {{ test_run.completed_at|timeuntil:test_run.started_at }}
    </div>
    {% endif %}
  </div>
</div>

<div class="section-header">Test Results Summary</div>
<div class="results-summary">
  <div class="summary-metric">
    <div class="metric-value">{{ total_tests }}</div>
    <div class="metric-label">Total Tests</div>
  </div>
  <div class="summary-metric">
    <div class="metric-value passed">{{ passed_tests }}</div>
    <div class="metric-label">Passed</div>
  </div>
  <div class="summary-metric">
    <div class="metric-value failed">{{ failed_tests }}</div>
    <div class="metric-label">Failed</div>
  </div>
  <div class="summary-metric">
    <div class="metric-value">{{ pass_rate }}%</div>
    <div class="metric-label">Pass Rate</div>
  </div>
</div>

<div class="section-header">Test Categories Breakdown</div>
{% if test_categories %}
<div class="categories-grid">
  {% for category, stats in test_categories.items %}
  <div class="category-card">
    <h4>{{ category|title }}</h4>
    <div class="category-stats">
      <div class="stat-item">
        <span class="stat-label">Total:</span>
        <span class="stat-value">{{ stats.total }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Passed:</span>
        <span class="stat-value passed">{{ stats.passed }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Pass Rate:</span>
        <span class="stat-value">
          {% if stats.total > 0 %}
            {% widthratio stats.passed stats.total 100 %}%
          {% else %}
            0%
          {% endif %}
        </span>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="section-header">Detailed Test Results</div>
{% if test_results %}
<table class="data-table">
  <thead>
    <tr>
      <th>Test Name</th>
      <th>Status</th>
      <th>Score</th>
      <th>Execution Time</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody>
    {% for result in test_results %}
    <tr>
      <td>{{ result.test_name }}</td>
      <td class="status-{{ result.passed|yesno:'passed,failed' }}">
        {{ result.passed|yesno:"PASSED,FAILED" }}
      </td>
      <td>
        {% if result.summary.score %}
          {{ result.summary.score|floatformat:3 }}
        {% else %}
          N/A
        {% endif %}
      </td>
      <td>
        {% if result.execution_time %}
          {{ result.execution_time|floatformat:2 }}s
        {% else %}
          N/A
        {% endif %}
      </td>
      <td>
        {% if result.summary %}
          <div class="test-details">
            {% for key, value in result.summary.items %}
              {% if key != 'score' %}
                <small>{{ key }}: {{ value }}</small><br>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p class="no-data">No test results available.</p>
{% endif %}

<div class="section-header">Evidence Artifacts</div>
{% if artifacts %}
<table class="data-table">
  <thead>
    <tr>
      <th>Artifact Type</th>
      <th>File Path</th>
      <th>File Info</th>
    </tr>
  </thead>
  <tbody>
    {% for artifact in artifacts %}
    <tr>
      <td>{{ artifact.artifact_type|title }}</td>
      <td>{{ artifact.file_path }}</td>
      <td>
        {% if artifact.file_info %}
          <div class="artifact-info">
            {% for key, value in artifact.file_info.items %}
              <small>{{ key }}: {{ value }}</small><br>
            {% endfor %}
          </div>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p class="no-data">No evidence artifacts generated.</p>
{% endif %}

{% if test_run.error_message %}
<div class="section-header">Error Information</div>
<div class="error-box">
  <strong>Error Message:</strong><br>
  <pre>{{ test_run.error_message }}</pre>
</div>
{% endif %}

<style>
.summary-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}

.summary-item {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 1rem;
}

.results-summary {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin: 1rem 0;
}

.summary-metric {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
}

.summary-metric .metric-value {
  font-size: 2rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.summary-metric .metric-value.passed {
  color: #28a745;
}

.summary-metric .metric-value.failed {
  color: #dc3545;
}

.summary-metric .metric-label {
  color: #6c757d;
  font-size: 0.9rem;
}

.categories-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 1rem 0;
}

.category-card {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 1rem;
}

.category-card h4 {
  margin: 0 0 1rem 0;
  color: #495057;
  text-align: center;
}

.category-stats {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.stat-label {
  font-weight: 500;
  color: #6c757d;
}

.stat-value {
  font-weight: bold;
}

.stat-value.passed {
  color: #28a745;
}

.test-details {
  font-size: 0.8rem;
  color: #6c757d;
}

.artifact-info {
  font-size: 0.8rem;
  color: #6c757d;
}

.error-box {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 8px;
  padding: 1rem;
  margin: 1rem 0;
}

.error-box pre {
  margin: 0.5rem 0 0 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.status-passed { color: #28a745; font-weight: bold; }
.status-failed { color: #dc3545; font-weight: bold; }
.status-running { color: #ffc107; font-weight: bold; }
.status-pending { color: #6c757d; font-weight: bold; }

.no-data {
  text-align: center;
  color: #6c757d;
  font-style: italic;
  padding: 2rem;
  background: #f8f9fa;
  border-radius: 8px;
}
</style>
{% endblock %}
