{% extends "reports/base_report.html" %}
{% block content %}
<style>
table.table-sm th, table.table-sm td {
  padding: 4px 6px;
  font-size: 12px;
  word-break: break-word;
  vertical-align: top;
}
tr, td, th { page-break-inside: avoid; }
h2, h3, h4 { page-break-after: avoid; margin-top: 1.5em; }
.issue-header-table { width: 100%; margin-bottom: 0.2em; border-collapse: collapse; }
.issue-header-table th, .issue-header-table td { font-size: 12px; padding: 2px 6px; border: 1px solid #e0e0e0; background: #f8f9fa; }
.issue-section { margin-bottom: 1.2em; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px 12px; background: #fff; }
.issue-label { font-weight: bold; color: #2563eb; margin-top: 0.5em; display: block; }
.truncate { max-width: 400px; white-space: pre-line; overflow: hidden; text-overflow: ellipsis; }
.section-title { background: #2563eb; color: #fff; padding: 6px 12px; border-radius: 4px; margin-top: 1.5em; }
</style>
<h2 class="section-title">Engagement Details (with Issues)</h2>
{% if engagement %}
  <table class="table table-sm">
    <tr><th>Engagement</th><td class="truncate">{{ engagement.title }}</td></tr>
    <tr><th>Status</th><td>{{ engagement.get_project_status_display }}</td></tr>
    <tr><th>Code</th><td>{{ engagement.code }}</td></tr>
    <tr><th>Workplan</th><td class="truncate">{{ engagement.audit_workplan.name }} ({{ engagement.audit_workplan.fiscal_year }})</td></tr>
    <tr><th>Type</th><td>{{ engagement.engagement_type }}</td></tr>
    <tr><th>Start Date</th><td>{{ engagement.project_start_date }}</td></tr>
    <tr><th>End Date</th><td>{{ engagement.target_end_date }}</td></tr>
    <tr><th>Assigned To</th><td>{{ engagement.assigned_to.email }}</td></tr>
    <tr><th>Executive Summary</th><td class="truncate">{{ engagement.executive_summary|striptags|truncatechars:300 }}</td></tr>
    <tr><th>Purpose</th><td class="truncate">{{ engagement.purpose|striptags|truncatechars:300 }}</td></tr>
    <tr><th>Background</th><td class="truncate">{{ engagement.background|striptags|truncatechars:300 }}</td></tr>
    <tr><th>Scope</th><td class="truncate">{{ engagement.scope|striptags|truncatechars:300 }}</td></tr>
    <tr><th>Objectives</th><td class="truncate">{{ engagement.project_objectives|striptags|truncatechars:300 }}</td></tr>
    <tr><th>Conclusion</th><td>{{ engagement.get_conclusion_display }}</td></tr>
    <tr><th>Conclusion Description</th><td class="truncate">{{ engagement.conclusion_description|striptags|truncatechars:300 }}</td></tr>
  </table>
  <h4 class="section-title">Issues</h4>
  {% if issues and issues|length > 0 %}
    {% for issue in issues %}
      <div class="issue-section">
        <table class="issue-header-table">
          <tr>
            <th>Code</th><td>{{ issue.code }}</td>
            <th>Title</th><td class="truncate">{{ issue.issue_title }}</td>
            <th>Status</th><td>{{ issue.get_issue_status_display }}</td>
            <th>Owner</th><td class="truncate">{{ issue.issue_owner.email|default:issue.issue_owner_email|default:'Unassigned' }}</td>
          </tr>
          <tr>
            <th>Remediation Status</th><td>{{ issue.get_remediation_status_display }}</td>
            <th>Remediation Deadline</th><td>{{ issue.remediation_deadline_date|default:'-' }}</td>
            <th>Actual Remediation Date</th><td>{{ issue.actual_remediation_date|default:'-' }}</td>
            <th>Severity</th><td>{{ issue.get_severity_status_display }}</td>
          </tr>
        </table>
        <span class="issue-label">Description:</span>
        <div class="truncate">{{ issue.issue_description|striptags|truncatechars:300 }}</div>
        <span class="issue-label">Root Cause:</span>
        <div class="truncate">{{ issue.root_cause|striptags|truncatechars:200 }}</div>
        <span class="issue-label">Risks:</span>
        <div class="truncate">{{ issue.risks|striptags|truncatechars:200 }}</div>
        <span class="issue-label">Recommendation:</span>
        <div class="truncate">{{ issue.recommendation|striptags|truncatechars:200 }}</div>
        <span class="issue-label">Management Action Plan:</span>
        <div class="truncate">{{ issue.management_action_plan|striptags|truncatechars:200 }}</div>
      </div>
    {% endfor %}
  {% else %}
    <p>No issues linked to this engagement.</p>
  {% endif %}
{% else %}
  <div class="alert alert-warning">No engagement found for the selected name.</div>
{% endif %}
{% endblock %} 