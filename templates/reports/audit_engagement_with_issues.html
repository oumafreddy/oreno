{% extends "reports/base_report.html" %}
{% load crispy_forms_tags %}
{% block content %}
<!-- PAGE 1: Logo and Title -->
<div style="text-align:center; margin-top: 80px;">
  {% if organization.logo and organization.logo.url %}
    <img src="{{ organization.logo.url }}" alt="{{ organization.name }} Logo" style="max-height:120px; max-width:300px; margin-bottom: 30px;" />
  {% endif %}
  <h1 style="margin-top: 30px; color: #2563eb;">Audit Engagement With Issues Report</h1>
</div>
<div style="page-break-after: always;"></div>
<!-- PAGE 2+: Engagement and Issues Details -->
{% if engagement %}
  <h2 class="section-title">Engagement Details</h2>
  <table class="table table-sm">
    <tr><th>Status</th><td>{{ engagement.get_project_status_display }}</td></tr>
    <tr><th>Type</th><td>{{ engagement.engagement_type }}</td></tr>
    <tr><th>Start Date</th><td>{{ engagement.project_start_date }}</td></tr>
    <tr><th>End Date</th><td>{{ engagement.target_end_date }}</td></tr>
    <tr><th>Engagement</th><td class="truncate">{{ engagement.title }}</td></tr>
    <tr><th>Code</th><td>{{ engagement.code }}</td></tr>
    <tr><th>Workplan</th><td class="truncate">{{ engagement.audit_workplan.name }} ({{ engagement.audit_workplan.fiscal_year }})</td></tr>
    <tr><th>Assigned To</th><td>{{ engagement.assigned_to.email }}</td></tr>
  </table>
  <span class="label">Executive Summary:</span>
  <div class="truncate">{{ engagement.executive_summary|striptags|truncatechars:300 }}</div>
  <span class="label">Purpose:</span>
  <div class="truncate">{{ engagement.purpose|striptags|truncatechars:300 }}</div>
  <span class="label">Background:</span>
  <div class="truncate">{{ engagement.background|striptags|truncatechars:300 }}</div>
  <span class="label">Scope:</span>
  <div class="truncate">{{ engagement.scope|striptags|truncatechars:300 }}</div>
  <span class="label">Objectives:</span>
  <div class="truncate">{{ engagement.project_objectives|striptags|truncatechars:300 }}</div>
  <span class="label">Conclusion:</span>
  <div>{{ engagement.get_conclusion_display }}</div>
  <span class="label">Conclusion Description:</span>
  <div class="truncate">{{ engagement.conclusion_description|striptags|truncatechars:300 }}</div>
  <h4 class="section-title">Issues</h4>
  {% if issues and issues|length > 0 %}
    {% for issue in issues %}
      <div class="issue-section mb-4">
        <table class="table table-sm">
          <tr><th>Status</th><td>{{ issue.get_issue_status_display }}</td></tr>
          <tr><th>Risk Level</th><td>{{ issue.get_risk_level_display }}</td></tr>
          <tr><th>Remediation Status</th><td>{{ issue.get_remediation_status_display }}</td></tr>
          <tr><th>Remediation Deadline</th><td>{{ issue.target_date|default:'-' }}</td></tr>
          <tr><th>Actual Remediation Date</th><td>{{ issue.actual_remediation_date|default:'-' }}</td></tr>
          <tr><th>Code</th><td>{{ issue.code }}</td></tr>
          <tr><th>Title</th><td class="truncate">{{ issue.issue_title }}</td></tr>
          <tr><th>Owner</th><td class="truncate">{{ issue.issue_owner.email|default:issue.issue_owner_email|default:'Unassigned' }}</td></tr>
        </table>
        <span class="issue-label">Description:</span>
        <div class="truncate">{{ issue.issue_description|striptags|truncatechars:300 }}</div>
        <span class="issue-label">Root Cause:</span>
        <div class="truncate">{{ issue.root_cause|striptags|truncatechars:200 }}</div>
        <span class="issue-label">Risks:</span>
        <div class="truncate">{{ issue.risks|striptags|truncatechars:200 }}</div>
        <span class="issue-label">Recommendation:</span>
        <div class="truncate">{{ issue.recommendation|striptags|truncatechars:200 }}</div>
        <span class="issue-label">Management Action Plan:</span>
        <div class="truncate">{{ issue.management_action_plan|striptags|truncatechars:200 }}</div>
      </div>
    {% endfor %}
  {% else %}
    <p>No issues linked to this engagement.</p>
  {% endif %}
{% else %}
  <div class="alert alert-warning">No engagement found for the selected name.</div>
{% endif %}
{% endblock %} 