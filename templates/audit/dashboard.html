{% extends "base.html" %}
{% load static %}
{% block title %}Audit Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <!-- Navigation Bar -->
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h2 class="mb-0">Audit Dashboard</h2>
        </div>
        <div class="col-auto ms-auto">
            <a href="{% url 'audit:workplan-list' %}" class="btn btn-primary me-2">Workplan List</a>
            <a href="{% url 'audit:engagement-list' %}" class="btn btn-outline-success me-2">Engagement List</a>
            <a href="{% url 'audit:issue-list' %}" class="btn btn-outline-danger me-2">Issue List</a>
        </div>
    </div>
    <!-- Period Filter -->
    <form method="get" class="row g-2 align-items-end mb-3" id="period-filter-form">
        <div class="col-auto">
            <label for="year-select" class="form-label mb-0">Year</label>
            <select id="year-select" name="year" class="form-select" multiple size="1">
                <option value="All" {% if filter_all %}selected{% endif %}>All</option>
                {% for y in available_years %}
                    <option value="{{ y }}" {% if y|stringformat:'s' in selected_years %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <label for="month-select" class="form-label mb-0">Month</label>
            <select id="month-select" name="month" class="form-select" multiple size="1" {% if filter_all %}disabled{% endif %}>
                {% for m, mname in available_months %}
                    <option value="{{ m }}" {% if m|stringformat:'s' in selected_months %}selected{% endif %}>{{ mname }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-outline-primary">Apply</button>
            <a href="?" class="btn btn-outline-secondary ms-2">Reset</a>
        </div>
        <div class="col-auto">
            <span class="text-muted small">Selected: 
                {% if filter_all %}All Years{% else %}
                    {{ selected_years|join:', ' }}
                    {% if selected_months %} ({{ selected_months|join:', ' }}){% endif %}
                {% endif %}
            </span>
        </div>
    </form>
    <!-- Advanced Analytics Cards (top) -->
    <div class="row mb-4 g-3">
        <div class="col-md-2">
            <div class="card text-bg-info h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-bar-chart"></i></div>
                    <h6 class="card-title">Engagement Statuses</h6>
                    <h3><a href="{% url 'audit:engagement-list' %}" class="stretched-link text-white text-decoration-none">{{ engagement_status_dist|length }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-success h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-clock-history"></i></div>
                    <h6 class="card-title">Avg. Engagement Duration (days)</h6>
                    <h3>{{ avg_engagement_duration|floatformat:1 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-danger h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-exclamation-triangle"></i></div>
                    <h6 class="card-title">Overdue Issues</h6>
                    <h3><a href="{% url 'audit:issue-list' %}?overdue=1" class="stretched-link text-white text-decoration-none">{{ overdue_issues }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-warning h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-pie-chart"></i></div>
                    <h6 class="card-title">Issue Risk Levels</h6>
                    <h3><a href="{% url 'audit:issue-list' %}" class="stretched-link text-white text-decoration-none">{{ issue_risk_dist|length }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-primary h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-check2-circle"></i></div>
                    <h6 class="card-title">Workplans Completed</h6>
                    <h3><a href="{% url 'audit:workplan-list' %}?status=Completed" class="stretched-link text-white text-decoration-none">{{ workplan_completion_rate.Completed }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-secondary h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-person-lines-fill"></i></div>
                    <h6 class="card-title">Approvals</h6>
                    <h3><a href="{% url 'audit:approval-report' %}" class="stretched-link text-white text-decoration-none">{{ approval_status_dist|length }}</a></h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Summary Cards Only, Organization Info Removed -->
    <div class="row mb-4 g-3">
        <div class="col-md-12">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card text-bg-primary h-100 text-center">
                        <div class="card-body">
                            <div class="display-6"><i class="bi bi-journal-check"></i></div>
                            <h6 class="card-title">Workplans</h6>
                            <h3><a href="{% url 'audit:workplan-list' %}" class="stretched-link text-white text-decoration-none">{{ workplan_count }}</a></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-bg-info h-100 text-center">
                        <div class="card-body">
                            <div class="display-6"><i class="bi bi-clipboard-data"></i></div>
                            <h6 class="card-title">Engagements</h6>
                            <h3><a href="{% url 'audit:engagement-list' %}" class="stretched-link text-white text-decoration-none">{{ engagement_count }}</a></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-bg-danger h-100 text-center">
                        <div class="card-body">
                            <div class="display-6"><i class="bi bi-exclamation-triangle"></i></div>
                            <h6 class="card-title">Issues</h6>
                            <h3><a href="{% url 'audit:issue-list' %}" class="stretched-link text-white text-decoration-none">{{ issue_count }}</a></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-bg-warning h-100 text-center">
                        <div class="card-body">
                            <div class="display-6"><i class="bi bi-hourglass-split"></i></div>
                            <h6 class="card-title">Approvals</h6>
                            <h3><a href="{% url 'audit:approval-report' %}" class="stretched-link text-white text-decoration-none">{{ approval_count }}</a></h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Advanced Analytics Charts (below summary cards) -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Engagement Status Distribution</strong></div>
                <div class="card-body">
                    <div id="engagement-status-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Issue Risk Levels Distribution</strong></div>
                <div class="card-body">
                    <div id="issue-risk-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Approval Status Distribution</strong></div>
                <div class="card-body">
                    <div id="approval-status-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Owner Workload Chart -->
    <div class="row mb-4 g-3">
        <div class="col-md-12">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Engagement Owner Workload</strong></div>
                <div class="card-body">
                    <div id="owner-workload-chart" style="height:250px;"></div>
                    <!-- Debug: Engagement Owner Workload Data (visible for troubleshooting) -->
                    <pre style="font-size:12px; background:#f8f9fa; border:1px solid #eee; padding:8px; margin-top:10px;">{{ engagement_owner_workload_debug }}</pre>
                </div>
            </div>
        </div>
    </div>
    <!-- Scrollable Recent Lists -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white"><i class="bi bi-clock-history me-2"></i>Recent Workplans</div>
                <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                    {% for workplan in recent_workplans %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'audit:workplan-detail' workplan.pk %}">{{ workplan.name }}</a>
                            <span class="badge bg-secondary">{{ workplan.fiscal_year }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No recent workplans.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white"><i class="bi bi-clock-history me-2"></i>Recent Engagements</div>
                <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                    {% for engagement in recent_engagements %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'audit:engagement-detail' engagement.pk %}">{{ engagement.title }}</a>
                            <span class="badge bg-secondary">WP: {{ engagement.audit_workplan.name }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No recent engagements.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white"><i class="bi bi-clock-history me-2"></i>Recent Issues</div>
                <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                    {% for issue in recent_issues %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'audit:issue-detail' issue.pk %}">{{ issue.issue_title }}</a>
                            <span class="badge bg-secondary">{{ issue.get_issue_status_display }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No recent issues.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <!-- Pending Approvals -->
    <div class="row mb-4 g-3">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark"><i class="bi bi-hourglass-split me-2"></i>Pending Approvals</div>
                <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                    {% for approval in pending_approvals %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ approval.content_object }}</span>
                            <span class="badge bg-secondary">{{ approval.get_status_display }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No pending approvals.</li>
                    {% endfor %}
                </ul>
                <div class="card-footer text-end">
                    <a href="{% url 'audit:approval-create' %}" class="btn btn-outline-warning">Request Approval</a>
                </div>
            </div>
        </div>
        <!-- Quick Links -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Quick Links</strong></div>
                <div class="card-body">
                    <a href="{% url 'audit:workplan-create' %}" class="btn btn-primary me-2">Create Workplan</a>
                    <a href="{% url 'audit:engagement-create' %}" class="btn btn-outline-info me-2">Create Engagement</a>
                    <a href="{% url 'audit:issue-create' %}" class="btn btn-outline-danger me-2">Create Issue</a>
                    <a href="{% url 'audit:approval-create' %}" class="btn btn-outline-warning me-2">Request Approval</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Export Cards Section -->
    <div class="row mb-4 g-4">
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white"><strong>Export Workplans</strong></div>
                <div class="card-body">
                    <form class="mb-2" method="get" action="{% url 'audit:export-workplans' %}">
                        <div class="mb-2">
                            <label class="form-label">Fiscal Year</label>
                            <input type="number" name="fiscal_year" class="form-control" placeholder="All">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Name</label>
                            <input type="text" name="name" class="form-control" placeholder="All">
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" name="format" value="csv" class="btn btn-outline-primary w-50">CSV</button>
                            <button type="submit" name="format" value="xlsx" class="btn btn-outline-primary w-50">Excel (XLSX)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-success text-white"><strong>Export Engagements</strong></div>
                <div class="card-body">
                    <form class="mb-2" method="get" action="{% url 'audit:export-engagements' %}">
                        <div class="mb-2">
                            <label class="form-label">Engagement Name</label>
                            <input type="text" name="name" class="form-control" placeholder="All">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Status</label>
                            <input type="text" name="status" class="form-control" placeholder="All">
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" name="format" value="csv" class="btn btn-outline-success w-50">CSV</button>
                            <button type="submit" name="format" value="xlsx" class="btn btn-outline-success w-50">Excel (XLSX)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-danger text-white"><strong>Export Issues</strong></div>
                <div class="card-body">
                    <form class="mb-2" method="get" action="{% url 'audit:export-issues' %}">
                        <div class="mb-2">
                            <label class="form-label">Issue Name</label>
                            <input type="text" name="name" class="form-control" placeholder="All">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Severity</label>
                            <input type="text" name="severity" class="form-control" placeholder="All">
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" name="format" value="csv" class="btn btn-outline-danger w-50">CSV</button>
                            <button type="submit" name="format" value="xlsx" class="btn btn-outline-danger w-50">Excel (XLSX)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Reports Section (Bottom) -->
    <div class="row mt-5">
      <div class="col">
        <div class="card shadow">
          <div class="card-header bg-primary text-white"><strong><i class="bi bi-file-earmark-bar-graph"></i> Audit Reports</strong></div>
          <div class="card-body">
            <div class="alert alert-info mb-4">
              <i class="bi bi-info-circle"></i> Generate and download a wide range of intelligent, filterable audit management reports. All reports are scoped to your organization and support PDF export.
            </div>
            <div class="row g-4">
              <!-- Workplan Summary Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Workplan Summary</h5>
                    <form method="get" action="{% url 'reports:audit_workplan_summary_pdf' %}" target="_blank">
                      <div class="mb-2">
                        <label class="form-label">Fiscal Year</label>
                        <input type="number" name="year" class="form-control" placeholder="All">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Status</label>
                        <input type="text" name="status" class="form-control" placeholder="All">
                      </div>
                      <button type="submit" class="btn btn-outline-primary w-100">Download PDF</button>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Engagement Summary Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Engagement Summary</h5>
                    <form method="get" action="{% url 'reports:audit_engagement_summary_pdf' %}" target="_blank">
                      <div class="mb-2">
                        <label class="form-label">Status</label>
                        <input type="text" name="status" class="form-control" placeholder="All" value="{{ request.GET.status|default:'' }}">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Assigned To (email)</label>
                        <input type="text" name="assigned_to" class="form-control" placeholder="All" value="{{ request.GET.assigned_to|default:'' }}">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Engagement Name</label>
                        <select name="engagement_name" class="form-select engagement-select">
                          <option value="">All</option>
                          {% for name in engagement_names %}
                            <option value="{{ name }}" {% if request.GET.engagement_name == name %}selected{% endif %}>{{ name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <button type="submit" class="btn btn-outline-primary w-100">Download PDF</button>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Issue Register Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Issue Register</h5>
                    <form method="get" action="{% url 'reports:audit_issue_register_pdf' %}" target="_blank">
                      <div class="mb-2">
                        <label class="form-label">Status</label>
                        <input type="text" name="status" class="form-control" placeholder="All" value="{{ request.GET.status|default:'' }}">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Severity</label>
                        <input type="text" name="severity" class="form-control" placeholder="All" value="{{ request.GET.severity|default:'' }}">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Engagement Name</label>
                        <select name="engagement_name" class="form-select engagement-select">
                          <option value="">All</option>
                          {% for name in engagement_names %}
                            <option value="{{ name }}" {% if request.GET.engagement_name == name %}selected{% endif %}>{{ name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <button type="submit" class="btn btn-outline-primary w-100">Download PDF</button>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Issue Follow-up Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Issue Follow-up</h5>
                    <form method="get" action="{% url 'reports:audit_issue_followup_pdf' %}" target="_blank">
                      <div class="mb-2">
                        <label class="form-label">Overdue Only</label>
                        <select name="overdue" class="form-select">
                          <option value="">No</option>
                          <option value="1">Yes</option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-outline-primary w-100">Download PDF</button>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Approval Workflow Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Approval Workflow</h5>
                    <form method="get" action="{% url 'reports:audit_approval_workflow_pdf' %}" target="_blank">
                      <div class="mb-2">
                        <label class="form-label">Status</label>
                        <input type="text" name="status" class="form-control" placeholder="All">
                      </div>
                      <button type="submit" class="btn btn-outline-primary w-100">Download PDF</button>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Smart Engagement Progress Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Smart Engagement Progress</h5>
                    <a href="{% url 'reports:audit_engagement_progress_pdf' %}" target="_blank" class="btn btn-outline-primary w-100">Download PDF</a>
                  </div>
                </div>
              </div>
              <!-- Engagement Details Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Engagement Details</h5>
                    <form method="get" action="{% url 'reports:audit_engagement_details_pdf' %}" target="_blank">
                      <div class="mb-2">
                        <label class="form-label">Engagement Name</label>
                        <select name="engagement_name" class="form-select engagement-select">
                          <option value="">All</option>
                          {% for name in engagement_names %}
                            <option value="{{ name }}" {% if request.GET.engagement_name == name %}selected{% endif %}>{{ name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <button type="submit" class="btn btn-outline-primary w-100">Download PDF</button>
                    </form>
                  </div>
                </div>
              </div>
              <!-- Engagement Details with Issues Report -->
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Engagement Details with Issues</h5>
                    <form method="get" action="{% url 'reports:audit_engagement_with_issues_pdf' %}" target="_blank">
                      <div class="mb-2">
                        <label class="form-label">Engagement Name</label>
                        <select name="engagement_name" class="form-select engagement-select">
                          <option value="">All</option>
                          {% for name in engagement_names %}
                            <option value="{{ name }}" {% if request.GET.engagement_name == name %}selected{% endif %}>{{ name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <button type="submit" class="btn btn-outline-primary w-100">Download PDF</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Notification Panel -->
    <div class="col-md-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-warning text-dark d-flex align-items-center">
                <i class="bi bi-bell me-2"></i> Recent Notifications
            </div>
            <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                {% for note in recent_notes %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'audit:note-modal-add' note.content_type_id note.object_id %}" class="text-decoration-none">
                            <span class="fw-bold">{{ note.get_note_type_display }}</span>: {{ note.content|truncatechars:60 }}
                        </a>
                        <span class="badge bg-{{ note.status|yesno:'success,secondary,danger' }}">{{ note.get_status_display }}</span>
                    </li>
                {% empty %}
                    <li class="list-group-item text-muted">No recent notes.</li>
                {% endfor %}
            </ul>
            <div class="card-footer text-end p-2">
                <a href="/audit/api/notes/" class="btn btn-sm btn-outline-primary">View All Notes</a>
            </div>
        </div>
    </div>
    <!-- Main Analytics Cards (spanning 8 columns) -->
    <div class="col-md-8">
        <div class="row g-3">
            <!-- Additional Recent Lists for Audit Workflow -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white"><i class="bi bi-list-task me-2"></i>Recent Engagements</div>
                    <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        {% for engagement in recent_engagements %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'audit:engagement-detail' engagement.pk %}">{{ engagement.title }}</a>
                                <span class="badge bg-secondary">WP: {{ engagement.audit_workplan.name }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No recent engagements.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white"><i class="bi bi-list-check me-2"></i>Recent Procedures</div>
                    <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        {% for procedure in recent_procedures %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'audit:procedure-detail' procedure.pk %}">{{ procedure.title }}</a>
                                <span class="badge bg-secondary">Risk: {{ procedure.risk.title }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No recent procedures.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white"><i class="bi bi-lightbulb me-2"></i>Recent Recommendations</div>
                    <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        {% for recommendation in recent_recommendations %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'audit:recommendation-detail' recommendation.pk %}">{{ recommendation.title }}</a>
                                <span class="badge bg-secondary">Issue: {{ recommendation.issue.issue_title }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No recent recommendations.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white"><i class="bi bi-clipboard-check me-2"></i>Recent Procedure Results</div>
                    <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        {% for result in recent_procedureresults %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'audit:procedureresult-detail' result.pk %}">{{ result.procedure.title }}</a>
                                <span class="badge bg-secondary">Status: {{ result.get_status_display }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No recent procedure results.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white"><i class="bi bi-arrow-repeat me-2"></i>Recent Follow-Up Actions</div>
                    <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        {% for action in recent_followupactions %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'audit:followupaction-detail' action.pk %}">{{ action.description|truncatechars:30 }}</a>
                                <span class="badge bg-secondary">Status: {{ action.get_status_display }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No recent follow-up actions.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white"><i class="bi bi-arrow-clockwise me-2"></i>Recent Issue Retests</div>
                    <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        {% for retest in recent_issueretests %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'audit:issueretest-detail' retest.pk %}">{{ retest.recommendation.title }}</a>
                                <span class="badge bg-secondary">Result: {{ retest.get_result_display }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No recent issue retests.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white"><i class="bi bi-sticky me-2"></i>Recent Notes</div>
                    <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        {% for note in recent_notes %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{% url 'audit:note-detail' note.pk %}">{{ note.get_note_type_display }}</a>
                                <span class="badge bg-secondary">Status: {{ note.get_status_display }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No recent notes.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- JSON data for Plotly charts -->
{{ engagement_status_dist|json_script:"engagement-status-data" }}
{{ issue_risk_dist|json_script:"issue-risk-data" }}
{{ approval_status_dist|json_script:"approval-status-data" }}
{{ engagement_owner_workload|json_script:"engagement-owner-workload-data" }}
<!-- Remove the inline script that renders charts. Only keep the json_script tags for data. -->
<!-- Add Select2 CSS -->
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet" />
<!-- Add Select2 JS -->
<script src="{% static 'js/select2.min.js' %}"></script>
<script>
  $(document).ready(function() {
    $('.engagement-select').select2({
      width: '100%',
      placeholder: 'Type or select...',
      allowClear: true
    });
  });
</script>
<!-- Dynamic Parent Selection Modal (reusable) -->
<div class="modal fade" id="parentSelectModal" tabindex="-1" aria-labelledby="parentSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="parentSelectModalLabel">Select Parent</h5></div>
      <div class="modal-body">
        <select id="parentSelectDropdown" class="form-select"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="parentSelectContinueBtn">Continue</button>
      </div>
    </div>
  </div>
</div>
<script>
// Dynamic Parent Selection Logic
function openParentSelectModal(type, parentApiUrl, createUrlTemplate) {
  $('#parentSelectDropdown').empty();
  $.get(parentApiUrl, function(data) {
    data.forEach(function(item) {
      $('#parentSelectDropdown').append(`<option value="${item.id}">${item.text}</option>`);
    });
    $('#parentSelectModal').modal('show');
    $('#parentSelectContinueBtn').off('click').on('click', function() {
      let parentId = $('#parentSelectDropdown').val();
      let createUrl = createUrlTemplate.replace('__PARENT_ID__', parentId);
      $('#parentSelectModal').modal('hide');
      $.get(createUrl, function(html) {
        $('#globalModal .modal-content').html(html);
        $('#globalModal').modal('show');
      });
    });
  });
}
</script>
<!-- Recent Procedures List with htmx filter -->
<form hx-get="{% url 'audit:htmx-procedure-list' %}" hx-target="#recentProceduresList" hx-swap="outerHTML" class="mb-2">
  <select name="risk" class="form-select select2">
    <option value="">All Risks</option>
    {% for risk in recent_risks %}
      <option value="{{ risk.pk }}">{{ risk.title }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-sm btn-outline-primary">Filter</button>
</form>
<div id="recentProceduresList">
  {% include 'audit/_procedure_list_partial.html' with procedures=recent_procedures %}
</div>
<!-- Recent Recommendations List with htmx filter -->
<form hx-get="{% url 'audit:htmx-recommendation-list' %}" hx-target="#recentRecommendationsList" hx-swap="outerHTML" class="mb-2">
  <select name="issue" class="form-select select2">
    <option value="">All Issues</option>
    {% for issue in recent_issues %}
      <option value="{{ issue.pk }}">{{ issue.issue_title }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-sm btn-outline-primary">Filter</button>
</form>
<div id="recentRecommendationsList">
  {% include 'audit/_recommendation_list_partial.html' with recommendations=recent_recommendations %}
</div>
<!-- Recent FollowUpActions List with htmx filter -->
<form hx-get="{% url 'audit:htmx-followupaction-list' %}" hx-target="#recentFollowupActionsList" hx-swap="outerHTML" class="mb-2">
  <select name="recommendation" class="form-select select2">
    <option value="">All Recommendations</option>
    {% for recommendation in recent_recommendations %}
      <option value="{{ recommendation.pk }}">{{ recommendation.title }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-sm btn-outline-primary">Filter</button>
</form>
<div id="recentFollowupActionsList">
  {# The partial expects an issue context, so we should not include it here unless we have an issue. #}
  {# If you want to show follow-ups grouped by issue, loop here. Otherwise, render a simple list. #}
  <ul class="list-group list-group-flush">
    {% for action in recent_followupactions %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <a href="{% url 'audit:followupaction-detail' action.pk %}">{{ action.description|truncatechars:30 }}</a>
        <span class="badge bg-secondary">Status: {{ action.get_status_display }}</span>
      </li>
    {% empty %}
      <li class="list-group-item text-muted">No recent follow-up actions.</li>
    {% endfor %}
  </ul>
</div>
<!-- Recent IssueRetests List with htmx filter -->
<form hx-get="{% url 'audit:htmx-issueretest-list' %}" hx-target="#recentIssueRetestsList" hx-swap="outerHTML" class="mb-2">
  <select name="recommendation" class="form-select select2">
    <option value="">All Recommendations</option>
    {% for recommendation in recent_recommendations %}
      <option value="{{ recommendation.pk }}">{{ recommendation.title }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-sm btn-outline-primary">Filter</button>
</form>
<div id="recentIssueRetestsList">
  <ul class="list-group list-group-flush">
    {% for retest in recent_issueretests %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <a href="{% url 'audit:issueretest-detail' retest.pk %}">{{ retest.recommendation.title }}</a>
        <span class="badge bg-secondary">Result: {{ retest.get_result_display }}</span>
      </li>
    {% empty %}
      <li class="list-group-item text-muted">No recent issue retests.</li>
    {% endfor %}
  </ul>
</div>
<!-- Recent Notes List with htmx filter -->
<form hx-get="{% url 'audit:htmx-note-list' %}" hx-target="#recentNotesList" hx-swap="outerHTML" class="mb-2">
  <input type="text" name="object_id" class="form-control mb-1" placeholder="Object ID (optional)">
  <input type="text" name="content_type_id" class="form-control mb-1" placeholder="Content Type ID (optional)">
  <button type="submit" class="btn btn-sm btn-outline-primary">Filter</button>
</form>
<div id="recentNotesList">
  {% include 'audit/_note_list_partial.html' with notes=recent_notes %}
</div>
<!-- Analytics Placeholders -->
<div class="row mb-4 g-3">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header bg-info text-white"><i class="bi bi-graph-up"></i> Issue Trend (Last 12 Months)</div>
      <div class="card-body"><div id="issue-trend-chart" style="height:250px;"></div></div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header bg-success text-white"><i class="bi bi-percent"></i> Completion Rates</div>
      <div class="card-body"><div id="completion-rate-chart" style="height:250px;"></div></div>
    </div>
  </div>
</div>
<div class="row mb-4 g-3">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header bg-primary text-white"><i class="bi bi-people"></i> User Activity</div>
      <div class="card-body"><div id="user-activity-chart" style="height:250px;"></div></div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header bg-warning text-dark"><i class="bi bi-calendar3"></i> Audit Activity Heatmap</div>
      <div class="card-body"><div id="audit-heatmap-chart" style="height:250px;"></div></div>
    </div>
  </div>
</div>
<!-- Select2 JS for dynamic selects -->
<script src="{% static 'js/select2.min.js' %}"></script>
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet" />
<script>$('.select2').select2();</script>
</div>
<div id="audit-dashboard-vars"
     data-engagement-url="{% url 'audit:api_engagement_data' %}"
     data-issue-url="{% url 'audit:api_issue_data' %}">
</div>
{% endblock %}
{% block extra_scripts %}
<script src="{% static 'js/audit_dashboard.js' %}" nonce="{{ request.csp_nonce }}"></script>
{% endblock %}
<pre style="background:#f8f9fa; color:#333; padding:10px; border:1px solid #eee;">
Engagement Status Data: {{ engagement_status_dist|safe }}
Issue Risk Data: {{ issue_risk_dist|safe }}
Approval Status Data: {{ approval_status_dist|safe }}
Owner Workload Data: {{ engagement_owner_workload|safe }}
</pre> 