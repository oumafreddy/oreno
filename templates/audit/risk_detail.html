{% extends "base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{{ risk.title }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'audit:dashboard' %}">{% trans "Audit" %}</a></li>
        {% if engagement %}
            <li class="breadcrumb-item"><a href="{% url 'audit:engagement-detail' pk=engagement.pk %}">{{ engagement.title }}</a></li>
        {% endif %}
        {% if objective %}
            <li class="breadcrumb-item"><a href="{% url 'audit:objective-detail' pk=objective.pk %}">{{ objective.title }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'audit:risk-list' objective_id=objective.pk %}">{% trans "Risks" %}</a></li>
        {% else %}
            <li class="breadcrumb-item"><a href="{% url 'audit:risk-list' %}">{% trans "Risks" %}</a></li>
        {% endif %}
        <li class="breadcrumb-item active" aria-current="page">{{ risk.title }}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-1">{{ risk.title }}</h2>
      <div class="text-muted">Status: {{ risk.get_status_display }} Â· Level: <span class="badge bg-{{ risk.get_risk_level_class }}">{{ risk.get_risk_level_display }}</span></div>
    </div>
    <div class="btn-group">
      <a href="{% url 'audit:risk-edit' pk=risk.pk %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-pencil"></i> {% trans "Edit" %}</a>
      <a href="{% url 'audit:risk-delete' pk=risk.pk %}" class="btn btn-outline-danger btn-sm" hx-get="{% url 'audit:risk-delete' pk=risk.pk %}" hx-target="#modal-body" data-bs-toggle="modal" data-bs-target="#mainModal"><i class="bi bi-trash"></i> {% trans "Delete" %}</a>
      {% if objective %}<a href="{% url 'audit:objective-detail' pk=objective.pk %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> {% trans "Back to Objective" %}</a>{% endif %}
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header"><strong>{% trans "Risk Information" %}</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-sm mb-0">
                <tr><th class="w-25">{% trans "Status" %}</th><td>{{ risk.get_status_display }}</td></tr>
                <tr><th>{% trans "Assigned To" %}</th><td>{% if risk.assigned_to %}{{ risk.assigned_to.get_full_name|default:risk.assigned_to.username }}{% else %}-{% endif %}</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-sm mb-0">
                <tr><th class="w-25">{% trans "Created" %}</th><td>{{ risk.created }} {% trans "by" %} {% if risk.created_by %}{{ risk.created_by.get_full_name|default:risk.created_by.username }}{% else %}-{% endif %}</td></tr>
                <tr><th>{% trans "Updated" %}</th><td>{{ risk.updated }} {% trans "by" %} {% if risk.updated_by %}{{ risk.updated_by.get_full_name|default:risk.updated_by.username }}{% else %}-{% endif %}</td></tr>
              </table>
            </div>
          </div>
          <div class="mt-3"><div class="content-wrapper">{{ risk.description|safe }}</div></div>
        </div>
      </div>

      <!-- Procedures -->
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>{% trans "Procedures" %}</strong>
          <a href="{% url 'audit:procedure-add' risk_id=risk.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-plus-circle"></i> {% trans "Add Procedure" %}</a>
        </div>
        <div class="card-body">
          {% if procedures %}
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>{% trans "Title" %}</th>
                  <th>{% trans "Status" %}</th>
                  <th>{% trans "Result" %}</th>
                  <th class="text-end">{% trans "Actions" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for procedure in procedures %}
                <tr>
                  <td><a href="{% url 'audit:procedure-detail' pk=procedure.pk %}">{{ procedure.title }}</a></td>
                  <td>{{ procedure.get_status_display }}</td>
                  <td>{% if procedure.result %}<span class="badge bg-secondary">{{ procedure.get_result_display }}</span>{% else %}<span class="badge bg-secondary">{% trans "Not Tested" %}</span>{% endif %}</td>
                  <td class="text-end">
                    <a href="{% url 'audit:procedure-detail' pk=procedure.pk %}" class="btn btn-sm btn-outline-primary">{% trans "View" %}</a>
                    <a href="{% url 'audit:procedure-edit' pk=procedure.pk %}" class="btn btn-sm btn-outline-secondary">{% trans "Edit" %}</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info mb-0">{% trans "No procedures found for this risk." %}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header"><strong>Quick Actions</strong></div>
        <div class="card-body d-grid gap-2">
          <a href="{% url 'audit:procedure-add' risk_id=risk.pk %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-plus-circle"></i> {% trans "Add Procedure" %}</a>
          {% if objective %}<a href="{% url 'audit:objective-detail' pk=objective.pk %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> {% trans "Back to Objective" %}</a>{% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
