{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Issue Detail - {{ issue.issue_title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-12">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'audit:dashboard' %}">Audit Dashboard</a></li>
          {% if issue.procedure %}
            {% if issue.procedure.risk %}
              {% if issue.procedure.risk.objective %}
                {% if issue.procedure.risk.objective.engagement %}
                  {% if issue.procedure.risk.objective.engagement.audit_workplan %}
                    <li class="breadcrumb-item"><a href="{% url 'audit:workplan-detail' issue.procedure.risk.objective.engagement.audit_workplan.pk %}">Workplan: {{ issue.procedure.risk.objective.engagement.audit_workplan.name }}</a></li>
                  {% endif %}
                  <li class="breadcrumb-item"><a href="{% url 'audit:engagement-detail' issue.procedure.risk.objective.engagement.pk %}">Engagement: {{ issue.procedure.risk.objective.engagement.title }}</a></li>
                {% endif %}
                <li class="breadcrumb-item"><a href="{% url 'audit:objective-detail' issue.procedure.risk.objective.pk %}">Objective: {{ issue.procedure.risk.objective.title }}</a></li>
              {% endif %}
              <li class="breadcrumb-item"><a href="{% url 'audit:risk-detail' issue.procedure.risk.pk %}">Risk: {{ issue.procedure.risk.title }}</a></li>
            {% endif %}
            <li class="breadcrumb-item"><a href="{% url 'audit:procedure-detail' issue.procedure.pk %}">Procedure: {{ issue.procedure.title }}</a></li>
          {% endif %}
          <li class="breadcrumb-item"><a href="{% url 'audit:issue-list' %}">Issues</a></li>
          <li class="breadcrumb-item active">{{ issue.issue_title }}</li>
        </ol>
      </nav>

      <!-- Issue Header & Info -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="mb-1">{{ issue.issue_title }}</h2>
          <div class="text-muted">Status: <span class="badge bg-{% if issue.issue_status == 'open' %}danger{% elif issue.issue_status == 'in_progress' %}warning{% else %}success{% endif %}">{{ issue.get_issue_status_display }}</span> Â· Severity: <span class="badge bg-{% if issue.risk_level == 'high' %}danger{% elif issue.risk_level == 'medium' %}warning{% else %}success{% endif %}">{{ issue.get_risk_level_display }}</span></div>
        </div>
        <div class="btn-group">
          <a href="{% url 'audit:issue-update' issue.pk %}" class="btn btn-outline-secondary btn-sm">Edit Issue</a>
          <a href="{% url 'audit:followupaction-add' issue_pk=issue.pk %}" class="btn btn-outline-primary btn-sm">Add Follow-up</a>
          <a href="{% url 'audit:issueretest-add' issue_pk=issue.pk %}" class="btn btn-outline-primary btn-sm">Add Retest</a>
          <a href="{% url 'audit:issueworkingpaper-add' issue_pk=issue.pk %}" class="btn btn-outline-secondary btn-sm">Add Working Paper</a>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header"><strong>Issue Details</strong></div>
            <div class="card-body">
              <h6>Description</h6>
              <div class="content-wrapper">{{ issue.issue_description|safe }}</div>
              <h6 class="mt-3">Root Cause</h6>
              <div class="content-wrapper">{{ issue.root_cause|safe }}</div>
              {% if issue.management_action_plan %}
              <h6 class="mt-3">Management Action Plan</h6>
              <div class="content-wrapper">{{ issue.management_action_plan|safe }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header"><strong>Issue Information</strong></div>
            <div class="card-body">
              <table class="table table-sm mb-0">
                <tr><th class="w-25">Code</th><td>{{ issue.code }}</td></tr>
                <tr><th>Owner</th><td>{% if issue.issue_owner %}{{ issue.issue_owner.get_full_name|default:issue.issue_owner.username }}{% else %}<span class="text-muted">Not assigned</span>{% endif %}</td></tr>
                <tr><th>Date Identified</th><td>{{ issue.date_identified }}</td></tr>
                {% if issue.target_date %}<tr><th>Target Date</th><td>{{ issue.target_date }}</td></tr>{% endif %}
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs for Related Items -->
      <div class="card mt-3">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="issueTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab">
                Recommendations
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="followups-tab" data-bs-toggle="tab" data-bs-target="#followups" type="button" role="tab">
                Follow-up Actions
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="retests-tab" data-bs-toggle="tab" data-bs-target="#retests" type="button" role="tab">
                Retests
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="workingpapers-tab" data-bs-toggle="tab" data-bs-target="#workingpapers" type="button" role="tab">
                Working Papers
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="issueTabsContent">
            <!-- Recommendations Tab -->
            <div class="tab-pane fade show active" id="recommendations" role="tabpanel">
              {% include 'audit/_recommendation_list_partial.html' with recommendations=issue.recommendations.all %}
            </div>
            
            <!-- Follow-up Actions Tab -->
            <div class="tab-pane fade" id="followups" role="tabpanel">
              {% include 'audit/_followupaction_list_partial.html' with followupactions=issue.followup_actions.all issue_id=issue.pk %}
            </div>
            
            <!-- Retests Tab -->
            <div class="tab-pane fade" id="retests" role="tabpanel">
              {% include 'audit/_issueretest_list_partial.html' with issueretests=issue.retests.all issue=issue %}
            </div>
            
            <!-- Working Papers Tab -->
            <div class="tab-pane fade" id="workingpapers" role="tabpanel">
              {% include 'audit/_issueworkingpaper_list_partial.html' with workingpapers=issue.working_papers.all issue=issue %}
    </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}