{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Engagement Detail - {{ engagement.title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-1">{{ engagement.title }}</h2>
      <div class="text-muted">Code: <span class="badge bg-primary">{{ engagement.code }}</span> Â· Status: <span class="badge bg-info">{{ engagement.get_project_status_display }}</span></div>
    </div>
    <div class="btn-group">
      <a href="{% url 'audit:engagement-update' engagement.pk %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-pencil"></i> Edit</a>
      <a href="{% url 'audit:objective-add' engagement_pk=engagement.pk %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-plus-circle"></i> Add Objective</a>
      <a href="{% url 'audit:note-add' %}?content_type_id={{ content_type_id }}&object_id={{ engagement.pk }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-journal-plus"></i> Add Note</a>
    </div>
  </div>

  <div class="row g-3">
    <!-- Main column -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header"><strong>Engagement Information</strong></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-sm mb-0">
                <tr><th class="w-25">Code</th><td>{{ engagement.code }}</td></tr>
                <tr><th>Type</th><td>{{ engagement.engagement_type|default:"Not specified" }}</td></tr>
                <tr><th>Start</th><td>{{ engagement.project_start_date }}</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-sm mb-0">
                <tr><th class="w-25">Target End</th><td>{{ engagement.target_end_date }}</td></tr>
                <tr><th>Assigned To</th><td>{% if engagement.assigned_to %}{{ engagement.assigned_to.get_full_name|default:engagement.assigned_to.username }}{% else %}<span class="text-muted">Not assigned</span>{% endif %}</td></tr>
                {% if engagement.estimated_hours %}<tr><th>Est. Hours</th><td>{{ engagement.estimated_hours }}</td></tr>{% endif %}
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><strong>Executive Summary & Details</strong></div>
        <div class="card-body">
          <div class="content-wrapper">
            <h6>Executive Summary</h6>
            <div>{{ engagement.executive_summary|safe }}</div>
            <h6 class="mt-3">Purpose</h6>
            <div>{{ engagement.purpose|safe }}</div>
            <h6 class="mt-3">Background</h6>
            <div>{{ engagement.background|safe }}</div>
            <h6 class="mt-3">Scope</h6>
            <div>{{ engagement.scope|safe }}</div>
            {% if engagement.criteria %}
              <h6 class="mt-3">Criteria</h6>
              <div>{{ engagement.criteria|safe }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Tabs for related lists -->
      <div class="card mt-3">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="engagementTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="objectives-tab" data-bs-toggle="tab" data-bs-target="#objectives" type="button" role="tab">
                Objectives
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="risks-tab" data-bs-toggle="tab" data-bs-target="#risks" type="button" role="tab">
                Risks
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="procedures-tab" data-bs-toggle="tab" data-bs-target="#procedures" type="button" role="tab">
                Procedures
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" type="button" role="tab">
                Issues
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                Notes
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="engagementTabsContent">
            <!-- Objectives Tab -->
            <div class="tab-pane fade show active" id="objectives" role="tabpanel">
              {% include 'audit/_objective_list_partial.html' with objectives=engagement.objectives.all engagement=engagement %}
            </div>
            
            <!-- Risks Tab -->
            <div class="tab-pane fade" id="risks" role="tabpanel">
              {% include 'audit/_risk_list_partial.html' with risks=engagement.all_risks.all engagement=engagement %}
            </div>
            
            <!-- Procedures Tab -->
            <div class="tab-pane fade" id="procedures" role="tabpanel">
              {% include 'audit/_procedure_list_partial.html' with procedures=engagement.all_procedures.all engagement=engagement %}
            </div>
            
            <!-- Issues Tab -->
            <div class="tab-pane fade" id="issues" role="tabpanel">
              {% include 'audit/_issue_list_partial.html' with issues=engagement.all_issues.all engagement=engagement %}
            </div>
            
            <!-- Notes Tab -->
            <div class="tab-pane fade" id="notes" role="tabpanel">
              {% include 'audit/_note_list_tab_partial.html' with notes=engagement.notes.all content_type_id=content_type_id object_id=engagement.pk %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header"><strong>Quick Actions</strong></div>
        <div class="card-body d-grid gap-2">
          <a href="{% url 'audit:objective-add' engagement_pk=engagement.pk %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-plus-circle"></i> Add Objective</a>
          <a href="{% url 'audit:note-add' %}?content_type_id={{ content_type_id }}&object_id={{ engagement.pk }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-journal-plus"></i> Add Note</a>
          <a href="{% url 'audit:engagement-list' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Back to List</a>
        </div>
      </div>
      
      <!-- Engagement Documents -->
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Engagement Documents</strong>
          <button type="button" class="btn btn-sm btn-outline-primary" 
                  hx-get="{% url 'audit:engagement-document-add' engagement_pk=engagement.pk %}"
                  hx-target="#engagementDocumentModal"
                  hx-swap="innerHTML"
                  data-bs-toggle="modal"
                  data-bs-target="#engagementDocumentModal">
            <i class="bi bi-upload"></i> Upload
          </button>
        </div>
        <div class="card-body" id="engagementDocumentsList">
          {% include 'audit/_engagementdocument_list_partial.html' with documents=documents engagement=engagement %}
        </div>
      </div>
      
      <!-- Modal for Document Upload -->
      <div class="modal fade" id="engagementDocumentModal" tabindex="-1" aria-labelledby="engagementDocumentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="engagementDocumentModalLabel">Upload Engagement Document</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="engagementDocumentModal">
              <!-- Form will be loaded here via HTMX -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} 