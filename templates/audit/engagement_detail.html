{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Engagement Detail - {{ engagement.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'audit:dashboard' %}">Audit Dashboard</a></li>
          <li class="breadcrumb-item"><a href="{% url 'audit:engagement-list' %}">Engagements</a></li>
          <li class="breadcrumb-item active">{{ engagement.title }}</li>
        </ol>
      </nav>

      <!-- Engagement Header -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="mb-0">{{ engagement.title }}</h3>
          <div class="btn-group" role="group">
            <a href="{% url 'audit:engagement-update' engagement.pk %}" class="btn btn-primary">Edit Engagement</a>
            <a href="{% url 'audit:objective-add' engagement_pk=engagement.pk %}" class="btn btn-success">Add Objective</a>
            <a href="{% url 'audit:note-add' %}?content_type_id={{ content_type_id }}&object_id={{ engagement.pk }}" class="btn btn-info">Add Note</a>
          </div>
        </div>
        <div class="card-body">
          <!-- Engagement Details -->
          <div class="row">
            <div class="col-md-8">
              <h5>Executive Summary</h5>
              <p>{{ engagement.executive_summary|safe }}</p>
              
              <h5>Purpose</h5>
              <p>{{ engagement.purpose|safe }}</p>
              
              <h5>Background</h5>
              <p>{{ engagement.background|safe }}</p>
              
              <h5>Scope</h5>
              <p>{{ engagement.scope|safe }}</p>
              
              {% if engagement.criteria %}
                <h5>Criteria</h5>
                <p>{{ engagement.criteria|safe }}</p>
              {% endif %}
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Engagement Information</h6>
                </div>
                <div class="card-body">
                  <dl class="row mb-0">
                    <dt class="col-sm-4">Code:</dt>
                    <dd class="col-sm-8">{{ engagement.code }}</dd>
                    
                    <dt class="col-sm-4">Type:</dt>
                    <dd class="col-sm-8">{{ engagement.get_engagement_type_display }}</dd>
                    
                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                      <span class="badge bg-{% if engagement.project_status == 'draft' %}secondary{% elif engagement.project_status == 'fieldwork' %}warning{% elif engagement.project_status == 'draft_report' %}info{% elif engagement.project_status == 'final_report' %}success{% else %}primary{% endif %}">
                        {{ engagement.get_project_status_display }}
                      </span>
                    </dd>
                    
                    <dt class="col-sm-4">Start Date:</dt>
                    <dd class="col-sm-8">{{ engagement.project_start_date }}</dd>
                    
                    <dt class="col-sm-4">Target End:</dt>
                    <dd class="col-sm-8">{{ engagement.target_end_date }}</dd>
                    
                    <dt class="col-sm-4">Assigned To:</dt>
                    <dd class="col-sm-8">
                      {% if engagement.assigned_to %}
                        {{ engagement.assigned_to.get_full_name|default:engagement.assigned_to.username }}
                      {% else %}
                        <span class="text-muted">Not assigned</span>
                      {% endif %}
                    </dd>
                    
                    {% if engagement.estimated_hours %}
                      <dt class="col-sm-4">Est. Hours:</dt>
                      <dd class="col-sm-8">{{ engagement.estimated_hours }}</dd>
                    {% endif %}
                  </dl>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs for Related Items -->
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="engagementTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="objectives-tab" data-bs-toggle="tab" data-bs-target="#objectives" type="button" role="tab">
                Objectives
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="risks-tab" data-bs-toggle="tab" data-bs-target="#risks" type="button" role="tab">
                Risks
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="procedures-tab" data-bs-toggle="tab" data-bs-target="#procedures" type="button" role="tab">
                Procedures
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" type="button" role="tab">
                Issues
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                Notes
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="engagementTabsContent">
            <!-- Objectives Tab -->
            <div class="tab-pane fade show active" id="objectives" role="tabpanel">
              {% include 'audit/_objective_list_partial.html' with objectives=engagement.objectives.all engagement=engagement %}
            </div>
            
            <!-- Risks Tab -->
            <div class="tab-pane fade" id="risks" role="tabpanel">
              {% include 'audit/_risk_list_partial.html' with risks=engagement.all_risks.all engagement=engagement %}
            </div>
            
            <!-- Procedures Tab -->
            <div class="tab-pane fade" id="procedures" role="tabpanel">
              {% include 'audit/_procedure_list_partial.html' with procedures=engagement.all_procedures.all engagement=engagement %}
            </div>
            
            <!-- Issues Tab -->
            <div class="tab-pane fade" id="issues" role="tabpanel">
              {% include 'audit/_issue_list_partial.html' with issues=engagement.all_issues.all engagement=engagement %}
            </div>
            
            <!-- Notes Tab -->
            <div class="tab-pane fade" id="notes" role="tabpanel">
              {% include 'audit/_note_list_tab_partial.html' with notes=engagement.notes.all content_type_id=content_type_id object_id=engagement.pk %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} 