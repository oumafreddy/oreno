{% extends 'base.html' %}
{% load static %}
{% block title %}Engagement: {{ engagement.title }} | Oreno GRC{% endblock %}
{% block content %}
<div class="container main-container">
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h3 mb-0">{{ engagement.title }}</h1>
        <div class="text-muted">Code: {{ engagement.code }}</div>
      </div>
      <div>
        <span class="badge bg-info fs-6 me-2">{{ engagement.project_status|capfirst }}</span>
      </div>
    </div>
    
    <div class="d-flex flex-wrap mt-3 gap-2">
      <a href="{% url 'audit:dashboard' %}" class="btn btn-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Audit Dashboard
      </a>
      <a href="{% url 'audit:engagement-update' engagement.pk %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-pencil"></i> Edit
      </a>
      <button class="btn btn-primary btn-sm" hx-get="{% url 'audit:objective-modal-add' engagement_pk=engagement.pk %}" hx-target="#modal-body" data-bs-toggle="modal" data-bs-target="#mainModal">
        <i class="bi bi-plus-circle"></i> Add Objective
      </button>
      <button class="btn btn-success btn-sm" hx-get="{% url 'audit:issue-create' %}?engagement={{ engagement.pk }}" hx-target="#modal-body" data-bs-toggle="modal" data-bs-target="#mainModal">
        <i class="bi bi-flag"></i> Add Issue
      </button>
      {% if content_type_id %}
      <button class="btn btn-info btn-sm" hx-get="{% url 'audit:note-modal-add' content_type_id=content_type_id object_id=engagement.pk %}" hx-target="#modal-body" data-bs-toggle="modal" data-bs-target="#mainModal">
        <i class="bi bi-sticky"></i> Add Note
      </button>
      {% else %}
      <button class="btn btn-info btn-sm" disabled title="Cannot add note: content type not available.">
        <i class="bi bi-sticky"></i> Add Note
      </button>
      {% endif %}
    </div>
  </div>
  <ul class="nav nav-tabs mb-3" id="engagementTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="objectives-tab" data-bs-toggle="tab" data-bs-target="#objectives" type="button" role="tab">Objectives</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" type="button" role="tab">Issues</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="procedures-tab" data-bs-toggle="tab" data-bs-target="#procedures" type="button" role="tab">Procedures</button>
    </li>
  </ul>
  <div class="tab-content" id="engagementTabsContent">
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
      <div class="card mb-4">
        <div class="card-body">
          <h5>Executive Summary</h5>
          <div>{{ engagement.executive_summary|safe }}</div>
          <h5 class="mt-4">Purpose</h5>
          <div>{{ engagement.purpose|safe }}</div>
          <h5 class="mt-4">Background</h5>
          <div>{{ engagement.background|safe }}</div>
          <h5 class="mt-4">Scope</h5>
          <div>{{ engagement.scope|safe }}</div>
          <h5 class="mt-4">Conclusion</h5>
          <div>{{ engagement.conclusion_description|safe }}</div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="objectives" role="tabpanel">
      {% include 'audit/_objective_list_partial.html' with objectives=engagement.objectives.all engagement=engagement %}
    </div>
    <div class="tab-pane fade" id="procedures" role="tabpanel">
      {% include 'audit/_procedure_list_partial.html' with procedures=engagement.all_procedures engagement=engagement %}
    </div>
    <div class="tab-pane fade" id="followup" role="tabpanel">
      {% for issue in engagement.all_issues %}
        <div class="mb-3">
          <h6>{{ issue.issue_title }}</h6>
          {% include 'audit/_followupaction_list_partial.html' with followups=issue.followupactions.all issue=issue %}
        </div>
      {% empty %}
        <div class="alert alert-info">No issues found for this engagement.</div>
      {% endfor %}
    </div>
    <div class="tab-pane fade" id="retest" role="tabpanel">
      {% for issue in engagement.all_issues %}
        <div class="mb-3">
          <h6>{{ issue.issue_title }}</h6>
          {% include 'audit/_issueretest_list_partial.html' with retests=issue.issueretests.all issue=issue %}
        </div>
      {% empty %}
        <div class="alert alert-info">No issues found for this engagement.</div>
      {% endfor %}
    </div>
    <div class="tab-pane fade" id="issues" role="tabpanel">
      {% include 'audit/_issue_list_tab_partial.html' with issues=engagement.all_issues engagement=engagement %}
    </div>
    <div class="tab-pane fade" id="notes" role="tabpanel">
      {% include 'audit/_note_list_tab_partial.html' with notes=engagement.all_notes content_type_id=content_type_id object_id=engagement.pk %}
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="mainModal" tabindex="-1" aria-labelledby="mainModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="modal-body">
      <!-- Modal content loaded here via htmx -->
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize bootstrap modal
    var mainModal = document.getElementById('mainModal');
    
    // Listen for HTMX events
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
      // Only handle responses for the modal target
      if (evt.detail.target.id === 'modal-body') {
        // Force the modal to show when content is loaded
        var bsModal = new bootstrap.Modal(mainModal);
        setTimeout(function() {
          bsModal.show();
        }, 50);
      }
    });
    
    // Close modal when the form is successfully submitted
    document.body.addEventListener('htmx:afterRequest', function(evt) {
      if (evt.detail.successful && evt.detail.target.closest('#modal-body')) {
        try {
          if (evt.detail.xhr.getResponseHeader('content-type') && 
              evt.detail.xhr.getResponseHeader('content-type').includes('application/json')) {
            var data = JSON.parse(evt.detail.xhr.responseText);
            if (data && data.form_is_valid) {
              var bsModal = bootstrap.Modal.getInstance(mainModal);
              if (bsModal) bsModal.hide();
              
              // Refresh the current tab content if needed
              var activeTab = document.querySelector('.tab-pane.active');
              if (activeTab && activeTab.id) {
                if (data.html_list) {
                  var listContainer = document.getElementById(activeTab.id + '-list-container');
                  if (listContainer) listContainer.innerHTML = data.html_list;
                }
              }
            }
          }
        } catch (e) {
          console.error('Error handling modal response:', e);
        }
      }
    });
  });
</script>
{% endblock %} 