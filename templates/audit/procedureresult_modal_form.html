{% load crispy_forms_tags %}
<div class="modal-header">
  <h5 class="modal-title">{% if object %}Edit{% else %}Add{% endif %} Procedure Result</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
  <form method="post" enctype="multipart/form-data" novalidate id="procedureresultForm" 
        hx-post="{% if object %}{% url 'audit:procedureresult-edit' object.pk %}{% else %}{% url 'audit:procedureresult-modal-add' procedure_pk=procedure_pk %}{% endif %}" 
        hx-target="#globalModal .modal-body" 
        hx-swap="innerHTML"
        hx-indicator="#procedureresult-spinner">
    {% csrf_token %}
    {{ form|crispy }}
    <div id="procedure-result-prompt" class="alert alert-info mt-3" style="display:none;"></div>
    <div class="d-flex justify-content-end mt-4">
      <div id="procedureresult-spinner" class="htmx-indicator me-2">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <button type="submit" class="btn btn-success">
        <i class="bi bi-save me-1"></i>Save
      </button>
      <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal" onclick="window.location.href='{% url 'audit:procedure-detail' procedure_pk %}'">
        <i class="bi bi-x me-1"></i>Cancel
      </button>
    </div>
  </form>
</div>
<script>
(function() {
  var form = document.getElementById('procedureresultForm');
  if (!form) return;

  // Handle form submission response
  form.addEventListener('htmx:afterRequest', function(event) {
    try {
      var detail = event.detail;
      if (detail && detail.xhr && detail.xhr.getResponseHeader('content-type') && 
          detail.xhr.getResponseHeader('content-type').includes('application/json')) {
        var data = JSON.parse(detail.xhr.responseText);
        if (data.form_is_valid) {
          // Update list container if provided
          if (data.html_list) {
            var container = document.getElementById('procedure-result-list-container');
            if (container) container.innerHTML = data.html_list;
          }
          // Update detail view if provided
          if (data.html_detail) {
            var detailContainer = document.getElementById('procedure-result-detail-container');
            if (detailContainer) detailContainer.innerHTML = data.html_detail;
          }
          // Close modal
          var modalEl = document.getElementById('globalModal');
          if (modalEl && window.bootstrap) {
            var modal = window.bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }
          // Show success message
          if (window.showToast) {
            window.showToast(data.message || 'Procedure result saved successfully!', 'success');
          }
        } else if (data.html_form) {
          document.getElementById('modal-body').innerHTML = data.html_form;
        }
      }
    } catch (e) {
      console.error('Error processing response:', e);
      if (window.showToast) {
        window.showToast('An error occurred while saving. Please try again.', 'danger');
      }
    }
  });

  // Add form validation
  form.addEventListener('submit', function(event) {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }
    form.classList.add('was-validated');
  });

  // Add file input validation
  var fileInputs = form.querySelectorAll('input[type="file"]');
  fileInputs.forEach(function(input) {
    input.addEventListener('change', function(event) {
      var file = event.target.files[0];
      if (file) {
        // Check file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          event.target.value = '';
          if (window.showToast) {
            window.showToast('File size must be less than 10MB', 'danger');
          }
        }
        // Check file type if needed
        var allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 
                          'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        if (!allowedTypes.includes(file.type)) {
          event.target.value = '';
          if (window.showToast) {
            window.showToast('Only PDF, Word, and image files are allowed', 'danger');
          }
        }
      }
    });
  });

  // Add prompt for positive finding or issue
  var resultField = document.getElementById('id_result');
  var promptDiv = document.getElementById('procedure-result-prompt');
  if (resultField && promptDiv) {
    function updatePrompt() {
      var value = resultField.value;
      if (value === 'operating_effectively') {
        promptDiv.style.display = 'block';
        promptDiv.className = 'alert alert-success mt-3';
        promptDiv.innerHTML = '<strong>Positive Finding:</strong> Please document any positive findings or best practices identified during this procedure.';
      } else if (value === 'not_effective' || value === 'partially_effective' || value === 'design_ineffective') {
        promptDiv.style.display = 'block';
        promptDiv.className = 'alert alert-warning mt-3';
        promptDiv.innerHTML = '<strong>Issue Required:</strong> This result indicates a control failure. Please ensure an Issue is created and linked to this procedure after saving.';
      } else {
        promptDiv.style.display = 'none';
        promptDiv.innerHTML = '';
      }
    }
    resultField.addEventListener('change', updatePrompt);
    updatePrompt();
  }
})();
</script> 