<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
<head>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="{% block meta_description %}GRC Management Platform{% endblock %}">
    <meta name="author" content="Oreno GRC Team">
    <meta name="robots" content="index, follow">
    
    <!-- AI/SEO Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Oreno GRC",
        "url": "{{ request.build_absolute_uri }}",
        "logo": "{% static 'img/logo.svg' %}",
        "description": "Governance, Risk and Compliance Management Platform"
    }
    </script>

    <title>{% block title %}Oreno GRC | {% block subtitle %}{% endblock %}{% endblock %}</title>

    <!-- Core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{% static 'img/favicon.ico' %}">

    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/toast.css' %}" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        /* Color palette */
        :root {
          --clr-primary:   #2563eb;
          --clr-secondary: #4f46e5;
          --clr-accent:    #22c55e;
          --clr-bg-light:  #f8fafc;
          --clr-bg-dark:   #1e293b;
          --clr-footer:    #111827;
          --clr-text-light:#adb5bd;
        }
  
        /* Base */
        body {
          font-family: 'Inter', system-ui, -apple-system, sans-serif;
          background-color: var(--clr-bg-light);
          display: flex;
          flex-direction: column;
          min-height: 100vh;
        }
        a { text-decoration: none; }
        a:hover { text-decoration: none; }
  
        /* Navbar */
        .navbar {
          padding-top: 0.5rem;
          padding-bottom: 0.5rem;
          background: linear-gradient(135deg, var(--clr-bg-dark), var(--clr-footer));
        }
        .navbar-brand {
          display: flex;
          align-items: center;
          font-weight: 600;
          font-size: 1.25rem;
          letter-spacing: 0.5px;
          color: var(--clr-accent) !important;
        }
        .navbar-brand img {
          margin-right: 0.5rem;
        }
        .navbar-nav .nav-link {
          padding: 0.5rem 1rem;
          font-weight: 500;
          color: #fff !important;
        }
        .navbar-nav .nav-link:hover {
          color: var(--clr-accent) !important;
        }
        .btn-ai {
          background: linear-gradient(135deg, var(--clr-primary), var(--clr-secondary));
          color: #fff;
          border-radius: 6px;
          padding: 0.4rem 0.9rem;
          font-weight: 500;
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-ai:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .dropdown-toggle::after {
          margin-left: 0.25rem;
        }
  
        /* Main Content */
        .main-content {
          flex: 1;
          padding: 2rem 1rem;
        }
        @media (min-width: 768px) {
          .main-content { padding: 3rem 2rem; }
        }
        .main-container {
          max-width: 960px;
          margin: 0 auto;
        }
  
        /* Footer */
        footer {
          background-color: var(--clr-footer);
          color: var(--clr-text-light);
          padding: 0.75rem 0; /* reduced vertical padding */
          font-size: 0.875rem;
        }
        footer h5 {
          color: #fff;
          font-weight: 600;
          margin-bottom: 0.5rem;
        }
        footer a {
          color: var(--clr-text-light);
          transition: color 0.15s;
        }
        footer a:hover {
          color: var(--clr-accent);
        }
        footer hr {
          border-color: #2c2f36;
          margin: 0.5rem 0;
        }
        .social-icons a {
          font-size: 1.2rem;
          margin-right: 0.75rem;
          color: var(--clr-text-light);
        }
        .social-icons a:hover {
          color: var(--clr-accent);
        }
        .footer-bottom {
          text-align: center;
          font-size: 0.8rem;
          margin-top: 0.25rem;
        }
      </style>
    {% block extra_head %}{% endblock %}
</head>

<body class="d-flex flex-column">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="{% static 'img/logo.svg' %}" alt="Logo" width="40" height="40" class="me-2">
                Oreno GRC
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="mainNav">
                {% if request.user.is_authenticated %}
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/audit/dashboard/">Audit</a></li>
                    <li class="nav-item"><a class="nav-link" href="/risk/">Risk</a></li>    
                    <li class="nav-item"><a class="nav-link" href="/compliance/">Compliance</a></li>                
                    <li class="nav-item"><a class="nav-link" href="/legal/">Legal</a></li>                    
                    <li class="nav-item"><a class="nav-link" href="/contracts/">Contracts</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'document_management:dashboard' %}">Documents</a></li>
                    <li class="nav-item"><a class="nav-link" href="/accounts/">Users</a></li>
                    <li class="nav-item"><a class="nav-link" href="/organizations/">Organizations</a></li>
                </ul>
                {% else %}
                <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                {% endif %}

                <ul class="navbar-nav mb-2 mb-lg-0">
                    <li class="nav-item position-relative">
                        <a class="nav-link ai-action-btn" href="#" data-bs-toggle="modal" data-bs-target="#aiAssistantModal">
                            <i class="bi bi-robot"></i> AI Assistant
                        </a>
                    </li>

                </ul>

                <!-- User Dropdown -->
                {% if request.user.is_authenticated %}
                <div class="dropdown">
                    <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" 
                    id="userMenu" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-2"></i>{{ request.user.get_short_name }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{% url 'users:user-detail' pk=request.user.pk %}">
                                <i class="bi bi-gear me-2"></i>Settings
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <!-- Logout POST form -->
                            <form method="post" action="{% url 'users:logout' %}" style="margin: 0; padding: 0;">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item text-danger" style="width: 100%; text-align: left;">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            {% if form and form.errors %}
                <div class="alert alert-danger">
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1056"></div>

    <!-- FOOTER -->
    <footer>
        <div class="container-fluid">
        <div class="row text-center text-md-start gy-3">
            <div class="col-md-4">
            <h5>Oreno GRC</h5>
            <p class="mb-0">Governance, Risk &amp; Compliance Platform</p>
            </div>
            <div class="col-md-2">
            <h5>Legal</h5>
            <ul class="list-unstyled mb-0">
                <li><a href="#">Privacy</a></li>
                <li><a href="#">Terms</a></li>
            </ul>
            </div>
            <div class="col-md-6 social-icons text-md-end">
            <a href="#"><i class="bi bi-github"></i></a>
            <a href="#"><i class="bi bi-linkedin"></i></a>
            <a href="#"><i class="bi bi-twitter"></i></a>
            </div>
        </div>
        <hr>
        <div class="footer-bottom">&copy; 2025 Oreno GRC. All rights reserved.</div>
        </div>
    </footer>

    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    <!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/modal-handler.js' %}"></script>
    <script src="{% static 'js/modal-context.js' %}"></script>

    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Nonce for CSP -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'nonce-{{ csp_nonce }}'">

    {% block extra_scripts %}{% endblock %}

    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXX"></script>
    <script nonce="{{ csp_nonce }}">
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXX');
    </script>
    <script src="{% static 'js/main.js' %}" defer></script>

    <!-- CKEditor5 -->
    <script type="module" src="{% static 'django_ckeditor_5/app.js' %}"></script>

    <!-- AI Assistant Button (fixed at bottom right) -->
    {% if request.user.is_authenticated %}
    <button type="button" class="btn btn-primary rounded-circle shadow"
            style="position: fixed; bottom: 2rem; right: 2rem; z-index: 1050;"
            data-bs-toggle="modal" data-bs-target="#aiAssistantModal"
            data-bs-toggle="tooltip" data-bs-placement="left" title="Ask Oreno AI Assistant about GRC best practices or platform features!">
        <i class="bi bi-robot"></i>
    </button>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    </script>
    {% endif %}

    <!-- AI Assistant Modal -->
    <div class="modal fade" id="aiAssistantModal" tabindex="-1" aria-labelledby="aiAssistantModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-bottom modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aiAssistantModalLabel">Oreno AI Assistant</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="ai-assistant-form" autocomplete="off">
              <div class="mb-3">
                <label for="ai-question" class="form-label">Ask a question about Oreno GRC or GRC best practices:</label>
                <textarea class="form-control" id="ai-question" rows="2" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-100" id="ai-ask-btn">Ask</button>
            </form>
            <div id="ai-answer" class="mt-3" style="display:none;">
              <div class="fw-bold mb-1">AI Answer:</div>
              <div id="ai-answer-text"></div>
            </div>
            <div id="ai-loading" class="text-center mt-3" style="display:none;">
              <div class="spinner-border text-primary" role="status"></div>
              <div>Thinking...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('ai-assistant-form');
        const questionInput = document.getElementById('ai-question');
        const answerDiv = document.getElementById('ai-answer');
        const answerText = document.getElementById('ai-answer-text');
        const loadingDiv = document.getElementById('ai-loading');
        const askBtn = document.getElementById('ai-ask-btn');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const question = questionInput.value.trim();
            if (!question) return;
            answerDiv.style.display = 'none';
            answerText.textContent = '';
            loadingDiv.style.display = 'block';
            askBtn.disabled = true;

            fetch('/api/ai/ask/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ question })
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                askBtn.disabled = false;
                if (data.answer) {
                    answerText.textContent = data.answer;
                    answerDiv.style.display = 'block';
                } else if (data.error) {
                    answerText.textContent = data.error;
                    answerDiv.style.display = 'block';
                } else {
                    answerText.textContent = 'Sorry, no answer was returned.';
                    answerDiv.style.display = 'block';
                }
            })
            .catch(() => {
                loadingDiv.style.display = 'none';
                askBtn.disabled = false;
                answerText.textContent = 'Sorry, there was a problem contacting the AI assistant.';
                answerDiv.style.display = 'block';
            });
        });

        // Helper to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    </script>

    <script>
    // Notification functionality has been removed
    </script>

    <!-- GLOBAL MODAL CONTAINER FOR AJAX FORMS -->
    <div class="modal fade" id="globalModal" tabindex="-1" aria-labelledby="globalModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="globalModalLabel">Loading...</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- HTMX CDN for advanced AJAX/modal support -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Follow-up Action Handler -->
    <script src="{% static 'js/followup-action-handler.js' %}" defer></script>

    <!-- Enhanced AJAX/htmx Modal Logic for Audit Models -->
    <script>
    (function() {
      // --- htmx Modal Support ---
      if (window.htmx) {
        // Listen for htmx requests to show spinner in modal
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
          var modal = document.querySelector('#globalModal .modal-body');
          if (modal) {
            modal.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
          }
        });

        // On htmx error, show error in modal with retry option
        document.body.addEventListener('htmx:responseError', function(evt) {
          var modal = document.querySelector('#globalModal .modal-body');
          if (modal) {
            modal.innerHTML = `
              <div class="alert alert-danger">
                <h5 class="alert-heading">Error</h5>
                <p>An error occurred while processing your request.</p>
                <hr>
                <div class="d-flex justify-content-end">
                  <button class="btn btn-outline-danger" onclick="window.location.reload()">Retry</button>
                </div>
              </div>`;
          }
        });

        // On htmx after swap, handle success and update UI
        document.body.addEventListener('htmx:afterSwap', function(evt) {
          if (evt.detail.xhr && evt.detail.xhr.status === 200 && evt.target.classList.contains('modal-body')) {
            try {
              var data = JSON.parse(evt.detail.xhr.responseText);
              if (data.form_is_valid) {
                // Update any list containers if provided
                if (data.html_list) {
                  var listContainer = document.querySelector(data.list_target || '.ajax-list-container');
                  if (listContainer) listContainer.innerHTML = data.html_list;
                }
                // Update detail view if provided
                if (data.html_detail) {
                  var detailContainer = document.querySelector(data.detail_target || '.ajax-detail-container');
                  if (detailContainer) detailContainer.innerHTML = data.html_detail;
                }
                // Show success message
                showToast(data.message || 'Saved successfully!', 'success');
                // Close modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('globalModal'));
                if (modal) modal.hide();
              } else if (data.html_form) {
                document.getElementById('modal-body').innerHTML = data.html_form;
              }
            } catch (e) {
              console.error('Error processing response:', e);
            }
          }
        });

        // Add global error handler for network issues
        document.body.addEventListener('htmx:sendError', function(evt) {
          showToast('Network error occurred. Please check your connection.', 'danger');
        });
      }

      // --- jQuery AJAX Modal Support ---
      $(function() {
        // Open modal via AJAX or htmx
        $(document).on('click', '[data-bs-toggle="modal"][data-ajax-url]', function(e) {
          e.preventDefault();
          var url = $(this).attr('data-ajax-url');
          var modal = $('#globalModal');
          var modalTitle = $(this).data('modal-title') || 'Form';
          modal.find('.modal-title').text(modalTitle);
          modal.find('.modal-body').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>');
          modal.modal('show');

          // Prefer htmx if present
          if (window.htmx) {
            modal.find('.modal-body').attr({
              'hx-get': url,
              'hx-target': '#globalModal .modal-body',
              'hx-swap': 'innerHTML',
              'hx-trigger': 'load'
            });
            window.htmx.process(modal.find('.modal-body')[0]);
          } else {
            $.get(url, function(data) {
              modal.find('.modal-body').html(data);
            }).fail(function() {
              modal.find('.modal-body').html(`
                <div class="alert alert-danger">
                  <h5 class="alert-heading">Error</h5>
                  <p>Failed to load the form. Please try again.</p>
                  <hr>
                  <div class="d-flex justify-content-end">
                    <button class="btn btn-outline-danger" onclick="window.location.reload()">Retry</button>
                  </div>
                </div>`);
            });
          }
        });

        // Submit modal form via AJAX or htmx
        $(document).on('submit', '#globalModal form', function(e) {
          if (window.htmx) return; // htmx will handle
          e.preventDefault();
          var form = $(this);
          var modal = $('#globalModal');
          var url = form.attr('action') || window.location.href;
          var method = form.attr('method') || 'post';
          var formData = new FormData(this);

          $.ajax({
            url: url,
            type: method,
            data: formData,
            processData: false,
            contentType: false,
            headers: { 'X-CSRFToken': $('meta[name="csrf-token"]').attr('content') },
            beforeSend: function() {
              modal.find('.modal-body').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>');
            },
            success: function(data) {
              if (data.form_is_valid) {
                if (data.html_list) {
                  $('.ajax-list-container').html(data.html_list);
                }
                if (data.html_detail) {
                  $('.ajax-detail-container').html(data.html_detail);
                }
                modal.modal('hide');
                showToast(data.message || 'Saved successfully!', 'success');
              } else if (data.html_form) {
                modal.find('.modal-body').html(data.html_form);
              }
            },
            error: function(xhr) {
              modal.find('.modal-body').html(`
                <div class="alert alert-danger">
                  <h5 class="alert-heading">Error</h5>
                  <p>An error occurred while saving. Please try again.</p>
                  <hr>
                  <div class="d-flex justify-content-end">
                    <button class="btn btn-outline-danger" onclick="window.location.reload()">Retry</button>
                  </div>
                </div>`);
            }
          });
        });
      });

      // Enhanced toast function with better styling and auto-dismiss
      window.showToast = function(message, type = 'success') {
        var toastId = 'toast-' + Date.now();
        var toastHtml = `
          <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-exclamation-circle' : 'bi-info-circle'} me-2"></i>
                ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>`;
        $('#toast-container').append(toastHtml);
        var toastEl = document.getElementById(toastId);
        var toast = new bootstrap.Toast(toastEl, { 
          delay: 3500,
          animation: true
        });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', function() { 
          $(toastEl).remove(); 
        });
      };
    })();
    </script>

    <!-- Form Submission Handler -->
    <script src="{% static 'js/form-submission.js' %}"></script>

    <!-- Main Modal for HTMX content -->
    <div class="modal fade" id="mainModal" tabindex="-1" aria-labelledby="mainModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div id="modal-body">
                    <!-- HTMX content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Global Modal (alias for compatibility) -->
    <div class="modal fade" id="globalModal" tabindex="-1" aria-labelledby="globalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div id="globalModal-body">
                    <!-- HTMX content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
