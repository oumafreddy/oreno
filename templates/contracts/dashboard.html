{% extends 'base.html' %}
{% load static %}
{% block title %}Contracts Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h2 class="mb-0">Contracts Dashboard</h2>
        </div>
        <div class="col-auto ms-auto">
            <a href="{% url 'contracts:reports' %}" class="btn btn-outline-warning me-2">Reports</a>
            <a href="{% url 'contracts:contract-list' %}" class="btn btn-primary me-2">Contract List</a>
            <a href="{% url 'contracts:party-list' %}" class="btn btn-outline-info me-2">Party List</a>
            <a href="{% url 'contracts:contracttype-list' %}" class="btn btn-outline-dark me-2">Contract Type List</a>
            <a href="{% url 'contracts:contractmilestone-list' %}" class="btn btn-outline-success">Milestone List</a>
        </div>
    </div>
    <!-- Advanced Analytics Cards (top) -->
    <div class="row mb-4 g-3">
        <div class="col-md-2">
            <div class="card text-bg-info h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-bar-chart"></i></div>
                    <h6 class="card-title">Statuses</h6>
                    <h3><a href="{% url 'contracts:contract-list' %}" class="stretched-link text-white text-decoration-none">{{ contract_status_dist|length }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-success h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-pie-chart"></i></div>
                    <h6 class="card-title">Types</h6>
                    <h3><a href="{% url 'contracts:contracttype-list' %}" class="stretched-link text-white text-decoration-none">{{ contract_type_dist|length }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-warning h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-people"></i></div>
                    <h6 class="card-title">Parties</h6>
                    <h3><a href="{% url 'contracts:party-list' %}" class="stretched-link text-white text-decoration-none">{{ party_count }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-secondary h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-calendar-event"></i></div>
                    <h6 class="card-title">Milestone Types</h6>
                    <h3><a href="{% url 'contracts:contractmilestone-list' %}" class="stretched-link text-white text-decoration-none">{{ milestone_type_dist|length }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-danger h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-exclamation-triangle"></i></div>
                    <h6 class="card-title">Milestone Statuses</h6>
                    <h3><a href="{% url 'contracts:contractmilestone-list' %}" class="stretched-link text-white text-decoration-none">{{ milestone_status_dist|length }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-bg-primary h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-calendar-range"></i></div>
                    <h6 class="card-title">Expiry Years</h6>
                    <h3><a href="{% url 'contracts:contract-list' %}" class="stretched-link text-white text-decoration-none">{{ contract_expiry_dist|length }}</a></h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Advanced Analytics Charts (below summary cards) -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Contract Status Distribution</strong></div>
                <div class="card-body">
                    <div id="contract-status-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Contracts by Type</strong></div>
                <div class="card-body">
                    <div id="contract-type-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Contracts by Party</strong></div>
                <div class="card-body">
                    <div id="contract-party-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Milestone Type Distribution</strong></div>
                <div class="card-body">
                    <div id="milestone-type-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Milestone Status Distribution</strong></div>
                <div class="card-body">
                    <div id="milestone-status-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Contract Expiry by Year</strong></div>
                <div class="card-body">
                    <div id="contract-expiry-chart" style="height:250px;"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Summary Cards -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card text-bg-primary h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-file-earmark-text"></i></div>
                    <h6 class="card-title">Contracts</h6>
                    <h3><a href="{% url 'contracts:contract-list' %}" class="stretched-link text-white text-decoration-none">{{ contract_count }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-info h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-people"></i></div>
                    <h6 class="card-title">Parties</h6>
                    <h3><a href="{% url 'contracts:party-list' %}" class="stretched-link text-white text-decoration-none">{{ party_count }}</a></h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-warning h-100 text-center">
                <div class="card-body">
                    <div class="display-6"><i class="bi bi-calendar-event"></i></div>
                    <h6 class="card-title">Milestones</h6>
                    <h3><a href="{% url 'contracts:contractmilestone-list' %}" class="stretched-link text-white text-decoration-none">{{ milestone_count }}</a></h3>
                </div>
            </div>
        </div>
    </div>
    <!-- Recent Contracts -->
    <div class="row mb-4 g-3">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Recent Contracts</strong></div>
                <ul class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                    {% for contract in recent_contracts %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'contracts:contract-detail' contract.pk %}">{{ contract.title }}</a>
                            <span class="badge bg-secondary">{{ contract.get_status_display }}</span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No recent contracts.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <!-- Quick Links -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-light"><strong>Quick Links</strong></div>
                <div class="card-body">
                    <a href="{% url 'contracts:contract-list' %}" class="btn btn-primary me-2 mb-2">Contract List</a>
                    <a href="{% url 'contracts:party-list' %}" class="btn btn-outline-info me-2 mb-2">Party List</a>
                    <a href="{% url 'contracts:contracttype-list' %}" class="btn btn-outline-dark me-2 mb-2">Contract Type List</a>
                    <a href="{% url 'contracts:contractmilestone-list' %}" class="btn btn-outline-success me-2 mb-2">Milestone List</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Reports Section (Bottom) -->
    <div class="row mt-5">
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <strong><i class="bi bi-file-earmark-bar-graph"></i> Contracts Reports</strong>
                </div>
                <div class="card-body text-center">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Access Professional Contract Reports</strong><br>
                        Generate and download comprehensive contract management reports with advanced filtering options.
                    </div>
                    <a href="{% url 'contracts:reports' %}" class="btn btn-warning btn-lg">
                        <i class="bi bi-file-earmark-text me-2"></i>View All Reports
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- END Contracts Reports Section -->
</div>
<!-- JSON data for Plotly charts -->
{{ contract_status_dist|json_script:"contract-status-data" }}
{{ contract_type_dist|json_script:"contract-type-data" }}
{{ contract_party_dist|json_script:"contract-party-data" }}
{{ milestone_type_dist|json_script:"milestone-type-data" }}
{{ milestone_status_dist|json_script:"milestone-status-data" }}
{{ contract_expiry_dist|json_script:"contract-expiry-data" }}
<!-- Modal for Contract List -->
<div class="modal fade" id="contractListModal" tabindex="-1" aria-labelledby="contractListModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contractListModalLabel">Contracts Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group">
          {% for contract in recent_contracts %}
            <li class="list-group-item"><a href="{% url 'contracts:contract-detail' contract.pk %}">{{ contract.title }}</a> - {{ contract.get_status_display }}</li>
          {% empty %}
            <li class="list-group-item text-muted">No contracts found.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
<div id="contracts-dashboard-vars"
     data-status-url="{% url 'contracts:api_status_data' %}"
     data-type-url="{% url 'contracts:api_type_data' %}"
     data-party-url="{% url 'contracts:api_party_data' %}"
     data-milestone-type-url="{% url 'contracts:api_milestone_type_data' %}"
     data-milestone-status-url="{% url 'contracts:api_milestone_status_data' %}"
     data-expiry-url="{% url 'contracts:api_expiry_data' %}">
</div>
{% endblock %}
{% block extra_scripts %}
<script src="{% static 'js/contracts_dashboard.js' %}" defer nonce="{{ request.csp_nonce }}"></script>
{% endblock %} 